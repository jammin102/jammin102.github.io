<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D 큐브 코인 시뮬레이터 (업데이트 시스템)</title>
    <!-- Tailwind CSS 로드 --><script src="https://cdn.tailwindcss.com"></script>
    <!-- Three.js (3D 라이브러리) 로드 --><script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- Chart.js (그래프 라이브러리) 로드 --><script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* 'Inter' 폰트 및 기본 스타일 적용 */
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden; /* 전체 페이지 스크롤 방지 */
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        
        /* 3D 캔버스 스타일 (renderer.domElement) */
        canvas {
            display: block;
        }
        
        /* 스크롤바 커스텀 */
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .history-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #93c5fd; border-radius: 20px; }
        .history-scrollbar::-webkit-scrollbar-thumb { background-color: #93c5fd; border-radius: 20px; }

        /* 비활성화된 버튼 스타일 */
        .btn-disabled {
            background-color: #4b5563 !important; /* gray-600 */
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        /* 탭 활성화 스타일 (v2) */
        .tab-active {
            border-bottom-color: #60a5fa !important;
            color: #60a5fa !important;
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <!-- 
    ==========================================
    업데이트 카운트다운 배너 (v.0.2.2)
    ==========================================
    -->
    <div id="update-countdown-banner" class="fixed top-0 left-0 right-0 bg-yellow-100 border-b-2 border-yellow-300 p-3 text-center text-gray-900 z-50 hidden" style="background-color: #ffeedd; border-color: #ffc97e; color: #7a4a00;">
        <div class="flex justify-between items-center max-w-6xl mx-auto px-4">
            <span class="font-bold text-lg">
                <span class="text-blue-600">v.0.2.2 프리즘 업데이트</span>가 잠시 후 시작됩니다!
            </span>
            <span id="countdown-timer" class="text-2xl font-bold text-red-600 bg-white px-3 py-1 rounded-lg shadow-inner">00:00:00</span>
            <button id="hide-countdown-banner" class="bg-gray-700 hover:bg-gray-800 text-white text-sm py-1 px-3 rounded-lg">&times; 숨기기</button>
        </div>
    </div>

    <!-- 
    ==========================================
    v0 (구 버전) 게임 컨테이너
    ==========================================
    -->
    <div id="v0-container" style="display: none;">
        <div class="flex flex-col lg:flex-row w-full h-screen">
            <!-- 왼쪽: 3D 뷰어 및 현재 가격 --><div id="v0-canvas-container" class="lg:w-1/2 w-full h-1/2 lg:h-full relative bg-black">
                <!-- 3D 캔버스가 여기에 마운트됨 (JS에서) --><!-- 현재 가격 표시 --><div class="absolute top-4 left-4 bg-black/50 backdrop-blur-sm p-4 rounded-lg shadow-xl z-20">
                    <h2 class="text-sm font-semibold text-blue-300 uppercase">CUBE-KRW</h2>
                    <div id="v0-current-price" class="text-4xl font-bold text-white">100,000 KRW</div>
                    <div id="v0-price-change" class="text-lg font-medium text-gray-300">-</div>
                </div>

                <!-- 큐브 구매 오버레이 --><div id="v0-cube-purchase-overlay" class="absolute inset-0 bg-black/70 backdrop-blur-sm flex flex-col justify-center items-center text-center p-4 z-10">
                    <h3 class="text-2xl font-bold mb-2">3D 큐브 잠금 해제</h3>
                    <p class="text-gray-300 mb-4">큐브의 실시간 3D 회전을 활성화하려면 10,000,000 KRW가 필요합니다.</p>
                    <button id="v0-buy-cube-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition-colors shadow-lg">
                        10,000,000 KRW에 구매
                    </button>
                </div>
            </div>

            <!-- 오른쪽: 대시보드 (자산, 매매, 뉴스, 거래 내역) --><div class="lg:w-1/2 w-full h-1/2 lg:h-full p-6 bg-gray-800 flex flex-col gap-4 overflow-y-auto history-scrollbar">
                <h1 class="text-3xl font-bold text-center text-white mb-2">큐브 코인 시뮬레이터</h1>

                <!-- 1. 내 자산 현황 --><div class="grid grid-cols-2 gap-4">
                    <div class="bg-gray-700 p-4 rounded-lg shadow-lg">
                        <h3 class="text-sm font-semibold text-gray-300">보유 현금 (KRW)</h3>
                        <div id="v0-user-cash" class="text-2xl font-bold text-blue-400">1,000,000</div>
                    </div>
                    <div class="bg-gray-700 p-4 rounded-lg shadow-lg">
                        <h3 class="text-sm font-semibold text-gray-300">보유 큐브 (CUBE)</h3>
                        <div id="v0-user-cubes" class="text-2xl font-bold text-purple-400">0</div>
                    </div>
                </div>

                <!-- 2. 매수 / 매도 입력 --><div class="bg-gray-700 p-4 rounded-lg shadow-lg">
                    <label for="v0-amount-input" class="text-sm font-semibold text-gray-300">거래 수량 (CUBE)</label>
                    <input type="number" id="v0-amount-input" value="1" min="1" class="w-full bg-gray-800 text-white p-2 rounded mt-2 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <div class="grid grid-cols-2 gap-4 mt-4">
                        <button id="v0-buy-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold p-3 rounded-lg transition-colors shadow-lg">
                            매수
                        </button>
                        <button id="v0-sell-button" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold p-3 rounded-lg transition-colors shadow-lg">
                            매도
                        </button>
                    </div>
                </div>

                <!-- 3. 실시간 가격 차트 --><div class="bg-gray-700 p-4 rounded-lg shadow-lg">
                    <h3 class="text-lg font-semibold mb-2 text-white">실시간 차트</h3>
                    <div class="h-40">
                        <canvas id="v0-price-chart"></canvas>
                    </div>
                </div>

                <!-- 4. 실시간 뉴스 --><div class="bg-gray-700 p-4 rounded-lg shadow-lg flex-grow flex flex-col">
                    <h3 class="text-lg font-semibold mb-2 text-white">실시간 큐브 뉴스</h3>
                    <div id="v0-news-feed" class="flex-grow h-24 overflow-y-auto history-scrollbar pr-2">
                        <div class="text-gray-400 text-sm">시뮬레이터가 시작되었습니다. 가격 변동을 기다립니다...</div>
                    </div>
                </div>

                <!-- 5. 거래 내역 --><div class="bg-gray-700 p-4 rounded-lg shadow-lg flex-grow flex flex-col">
                    <h3 class="text-lg font-semibold mb-2 text-white">거래 내역</h3>
                    <div id="v0-transaction-history" class="flex-grow h-32 overflow-y-auto history-scrollbar pr-2">
                        <!-- 거래 내역이 여기에 추가됩니다 --><div class="text-gray-400 text-sm text-center p-4">거래 내역이 없습니다.</div>
                    </div>
                </div>

                <!-- 6. 코드 입력 (v0에 추가) -->
                <div class="bg-gray-700 p-4 rounded-lg shadow-lg">
                    <h3 class="text-lg font-semibold mb-2 text-white">코드 입력</h3>
                    <div class="flex gap-4">
                        <input type="text" id="v0-code-input" class="w-full bg-gray-800 text-white p-2 rounded border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="코드를 입력하세요 (코드당 1회)">
                        <button id="v0-code-submit-button" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded-lg transition-colors shadow-lg">입력</button>
                    </div>
                </div>

            </div>
        </div>
        
        <!-- 알림 메시지 (에러 등) --><div id="v0-notification" class="fixed bottom-6 right-6 bg-red-500 text-white p-4 rounded-lg shadow-xl transition-all duration-300 opacity-0 translate-y-10 z-50">
            메시지 내용
        </div>
    </div> <!-- v0-container 끝 -->

    <!-- 
    ==========================================
    v2 (신 버전 v.0.2.2) 게임 컨테이너
    ==========================================
    -->
    <div id="v2-container" style="display: none;">
        <div class="flex flex-col lg:flex-row w-full h-screen">
            <!-- 왼쪽: 3D 뷰어 및 현재 가격 -->
            <div id="v2-canvas-container" class="lg:w-1/2 w-full h-1/2 lg:h-full relative bg-black transition-all duration-300">
                <!-- 3D 캔버스 -->
                <div class="absolute top-4 left-4 bg-black/50 backdrop-blur-sm p-4 rounded-lg shadow-xl z-20">
                    <!-- CUBE 가격 -->
                    <div>
                        <h2 class="text-sm font-semibold text-blue-300 uppercase">CUBE-KRW</h2>
                        <div id="v2-current-price" class="text-3xl font-bold text-white">10,000 KRW</div>
                        <div id="v2-price-change" class="text-lg font-medium text-gray-300">-</div>
                    </div>
                    <!-- PRISM 가격 -->
                    <div class="mt-4">
                        <h2 class="text-sm font-semibold text-pink-300 uppercase">PRISM-KRW</h2>
                        <div id="v2-current-prism-price" class="text-3xl font-bold text-white">50,000 KRW</div>
                        <div id="v2-prism-price-change" class="text-lg font-medium text-gray-300">-</div>
                    </div>
                </div>

                <!-- 하단 UI 래퍼 (패시브 수입 + 업그레이드 버튼) -->
                <div class="absolute bottom-4 left-4 flex flex-col md:flex-row gap-4 items-start md:items-end z-20">
                    <div id="v2-passive-income-display" class="bg-black/50 backdrop-blur-sm p-3 rounded-lg shadow-xl hidden">
                        <h3 class="text-sm font-semibold text-green-300">패시브 수입</h3>
                        <div id="v2-income-per-second" class="text-lg font-bold text-white">+0 KRW / sec</div>
                    </div>
                    <div id="v2-upgrade-prism-section" class="bg-black/50 backdrop-blur-sm p-4 rounded-lg shadow-xl text-center hidden">
                        <h3 class="text-lg font-bold mb-2 text-pink-300">프리즘 업그레이드</h3>
                        <p class="text-gray-300 text-sm mb-3">큐브를 프리즘으로 업그레이드 (초당 200 KRW)<br>(필요: 100 PRISM)</p>
                        <button id="v2-upgrade-prism-button" class="w-full bg-pink-600 hover:bg-pink-700 text-white font-bold py-2 px-4 rounded-lg transition-colors shadow-lg">
                            100 PRISM에 업그레이드
                        </button>
                    </div>
                </div>

                <!-- 큐브 구매 오버레이 -->
                <div id="v2-cube-purchase-overlay" class="absolute inset-0 bg-black/70 backdrop-blur-sm flex flex-col justify-center items-center text-center p-4 z-10">
                    <div id="v2-buy-cube-section">
                        <h3 class="text-2xl font-bold mb-2">3D 큐브 잠금 해제</h3>
                        <p class="text-gray-300 mb-4">큐브의 실시간 3D 회전을 활성화하고 초당 100 KRW를 생산하려면 10,000,000 KRW가 필요합니다.</p>
                        <button id="v2-buy-cube-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition-colors shadow-lg">
                            10,000,000 KRW에 구매
                        </button>
                    </div>
                </div>
            </div>

            <!-- 오른쪽: 대시보드 (v2) -->
            <div id="v2-dashboard" class="lg:w-1/2 w-full h-1/2 lg:h-full p-6 bg-gray-800 flex flex-col gap-4 overflow-y-auto custom-scrollbar transition-all duration-300">
                <h1 class="text-3xl font-bold text-center text-white mb-2">큐브 코인 시뮬레이터 v.0.2.2</h1>

                <!-- 1. 내 자산 현황 -->
                <div class="bg-gray-700 rounded-lg shadow-lg">
                    <div class="flex justify-between items-center p-4 cursor-pointer" id="v2-toggle-assets">
                        <h3 class="text-lg font-semibold text-white">내 자산 현황</h3>
                        <svg class="w-5 h-5 text-gray-400" id="v2-toggle-assets-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                    <div id="v2-content-assets" class="px-4 pb-4">
                        <div class="grid grid-cols-3 gap-4">
                            <div class="bg-gray-600 p-4 rounded-lg">
                                <h3 class="text-sm font-semibold text-gray-300">보유 현금 (KRW)</h3>
                                <div id="v2-user-cash" class="text-2xl font-bold text-blue-400">100,000</div>
                            </div>
                            <div class="bg-gray-600 p-4 rounded-lg">
                                <h3 class="text-sm font-semibold text-gray-300">보유 큐브 (CUBE)</h3>
                                <div id="v2-user-cubes" class="text-2xl font-bold text-purple-400">0</div>
                            </div>
                            <div class="bg-gray-600 p-4 rounded-lg">
                                <h3 class="text-sm font-semibold text-gray-300">보유 프리즘 (PRISM)</h3>
                                <div id="v2-user-prisms" class="text-2xl font-bold text-pink-400">0</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2. 매수 / 매도 -->
                <div class="bg-gray-700 rounded-lg shadow-lg">
                    <div class="flex justify-between items-center p-4 cursor-pointer" id="v2-toggle-trade">
                        <h3 class="text-lg font-semibold text-white">매수 / 매도</h3>
                        <svg class="w-5 h-5 text-gray-400" id="v2-toggle-trade-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                    <div id="v2-content-trade" class="px-4 pb-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- CUBE 거래 -->
                            <div class="bg-gray-600 p-4 rounded-lg">
                                <label class="text-lg font-semibold text-blue-300">CUBE 거래</label>
                                <input type="number" id="v2-amount-input-cube" value="1" min="1" class="w-full bg-gray-800 text-white p-2 rounded mt-2 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="CUBE 수량">
                                <div class="grid grid-cols-2 gap-4 mt-4">
                                    <button id="v2-buy-button-cube" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold p-3 rounded-lg transition-colors shadow-lg">매수</button>
                                    <button id="v2-sell-button-cube" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold p-3 rounded-lg transition-colors shadow-lg">매도</button>
                                </div>
                            </div>
                            <!-- PRISM 거래 -->
                            <div class="bg-gray-600 p-4 rounded-lg">
                                <label class="text-lg font-semibold text-pink-300">PRISM 거래</label>
                                <input type="number" id="v2-amount-input-prism" value="1" min="1" class="w-full bg-gray-800 text-white p-2 rounded mt-2 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-pink-500" placeholder="PRISM 수량">
                                <div class="grid grid-cols-2 gap-4 mt-4">
                                    <button id="v2-buy-button-prism" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold p-3 rounded-lg transition-colors shadow-lg">매수</button>
                                    <button id="v2-sell-button-prism" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold p-3 rounded-lg transition-colors shadow-lg">매도</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 3. 실시간 가격 차트 (탭) -->
                <div class="bg-gray-700 rounded-lg shadow-lg">
                    <div class="flex justify-between items-center p-4 cursor-pointer" id="v2-toggle-charts">
                        <h3 class="text-lg font-semibold text-white">실시간 차트</h3>
                        <svg class="w-5 h-5 text-gray-400" id="v2-toggle-charts-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                    <div id="v2-content-charts" class="px-4 pb-4">
                        <nav class="flex border-b border-gray-600 mb-4">
                            <button id="v2-chart-tab-cube" class="py-2 px-4 border-b-2 border-transparent text-gray-400 hover:text-white tab-active">CUBE</button>
                            <button id="v2-chart-tab-prism" class="py-2 px-4 border-b-2 border-transparent text-gray-400 hover:text-white">PRISM</button>
                        </nav>
                        <div id="v2-chart-cube-container" class="h-40"><canvas id="v2-price-chart"></canvas></div>
                        <div id="v2-chart-prism-container" class="h-40 hidden"><canvas id="v2-prism-price-chart"></canvas></div>
                    </div>
                </div>

                <!-- 4. 거래 내역 -->
                <div class="bg-gray-700 rounded-lg shadow-lg">
                    <div class="flex justify-between items-center p-4 cursor-pointer" id="v2-toggle-history">
                        <h3 class="text-lg font-semibold text-white">거래 내역</h3>
                        <svg class="w-5 h-5 text-gray-400" id="v2-toggle-history-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                    <div id="v2-content-history" class="px-4 pb-4">
                        <div id="v2-transaction-history" class="h-32 overflow-y-auto custom-scrollbar pr-2 bg-gray-600 rounded-lg p-2">
                            <div class="text-gray-400 text-sm text-center p-4">거래 내역이 없습니다.</div>
                        </div>
                    </div>
                </div>

                <!-- 5. 실시간 뉴스 -->
                <div class="bg-gray-700 rounded-lg shadow-lg">
                    <div class="flex justify-between items-center p-4 cursor-pointer" id="v2-toggle-news">
                        <h3 class="text-lg font-semibold text-white">실시간 큐브 뉴스 (예측)</h3>
                        <svg class="w-5 h-5 text-gray-400" id="v2-toggle-news-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                    <div id="v2-content-news" class="px-4 pb-4">
                        <div id="v2-news-feed" class="h-24 overflow-y-auto custom-scrollbar pr-2 bg-gray-600 rounded-lg p-2">
                            <div class="text-gray-400 text-sm">시뮬레이터가 시작되었습니다. 다음 이벤트를 기다립니다...</div>
                        </div>
                    </div>
                </div>

                <!-- 6. 돈벌이 -->
                <div class="bg-gray-700 rounded-lg shadow-lg">
                    <div class="flex justify-between items-center p-4 cursor-pointer" id="v2-toggle-jobs">
                        <h3 class="text-lg font-semibold text-white">다양한 돈벌이</h3>
                        <svg class="w-5 h-5 text-gray-400" id="v2-toggle-jobs-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                    <div id="v2-content-jobs" class="px-4 pb-4">
                        <div class="grid grid-cols-1 gap-4">
                            <button id="v2-job-paper" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold p-3 rounded-lg transition-colors shadow-lg">
                                폐지 줍기 (+500)
                                <span id="v2-job-paper-timer" class="text-xs block"></span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 7. 코드 입력 -->
                <div class="bg-gray-700 rounded-lg shadow-lg">
                    <div class="flex justify-between items-center p-4 cursor-pointer" id="v2-toggle-code">
                        <h3 class="text-lg font-semibold text-white">코드 입력</h3>
                        <svg class="w-5 h-5 text-gray-400" id="v2-toggle-code-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                    <div id="v2-content-code" class="px-4 pb-4">
                        <div class="flex gap-4">
                            <input type="text" id="v2-code-input" class="w-full bg-gray-800 text-white p-2 rounded border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="코드를 입력하세요 (코드당 1회)">
                            <button id="v2-code-submit-button" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded-lg transition-colors shadow-lg">입력</button>
                        </div>
                    </div>
                </div>
                
                <!-- 8. 업데이트 내역 (v.0.2.2) -->
                <div class="bg-gray-700 rounded-lg shadow-lg">
                    <div class="flex justify-between items-center p-4 cursor-pointer" id="v2-toggle-updates">
                        <h3 class="text-lg font-semibold text-white">업데이트 내역 (v.0.2.2)</h3>
                        <svg class="w-5 h-5 text-gray-400" id="v2-toggle-updates-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                    <div id="v2-content-updates" class="px-4 pb-4 hidden">
                        <ul class="list-disc list-inside text-gray-300 text-sm space-y-1">
                            <li>콘솔 오류(SyntaxError) 수정 및 Firebase 로직 안정화</li>
                            <li>코드 입력 횟수 1회 제한 (계정당)</li>
                            <li>프리즘 업그레이드 UI 위치 변경 (패시브 수입창 옆)</li>
                            <li>'벽돌 운반' 기능 제거</li>
                            <li>'폐지 줍기' 발전과제 시스템 추가 (최대 5배 수입)</li>
                            <li>v.0.2.2 업데이트 내역 추가</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 알림 메시지 (v2) --><div id="v2-notification" class="fixed bottom-6 right-6 bg-red-500 text-white p-4 rounded-lg shadow-xl transition-all duration-300 opacity-0 translate-y-10 z-50">
            메시지 내용
        </div>
    </div> <!-- v2-container 끝 -->


    <!-- 
    ==========================================
    공통 JavaScript
    ==========================================
    -->
    <script>
        // --- 전역 설정 ---
        let db, auth, userId, appId;
        
        // --- 시간 설정 (KST = UTC+9) ---
        // 업데이트 시간: 2025년 11월 14일 오후 6시 00분 00초
        const UPDATE_TIME = new Date('2025-11-14T18:00:00+09:00');
        // 카운트다운 시작 시간: 2025년 11월 14일 오후 5시 00분 00초
        const COUNTDOWN_START_TIME = new Date('2025-11-14T17:00:00+09:00');
        
        // --- 시간 헬퍼 ---
        function getCurrentTime() {
            const devTimeStr = sessionStorage.getItem('devTestTime');
            if (devTimeStr) {
                // 개발자 테스트 시간이 설정된 경우, 1회 사용 후 삭제
                sessionStorage.removeItem('devTestTime');
                console.log("Using Dev Test Time:", devTimeStr);
                return new Date(devTimeStr);
            }
            return new Date();
        }

        // --- 공용 헬퍼 ---
        function getDynamicRiseProbability(baseProb, currentTime, updateTime) {
            const msBeforeUpdate = updateTime.getTime() - currentTime.getTime();
            
            if (msBeforeUpdate > 0) { // 업데이트 전
                const minutesBefore = msBeforeUpdate / (1000 * 60);

                if (minutesBefore <= 1) return baseProb + 0.05;   // 1분 전: +5%
                if (minutesBefore <= 5) return baseProb + 0.025;  // 5분 전: +2.5%
                if (minutesBefore <= 10) return baseProb + 0.02;  // 10분 전: +2%
                if (minutesBefore <= 30) return baseProb + 0.01;  // 30분 전: +1%
                if (minutesBefore <= 60) return baseProb + 0.005; // 1시간 전: +0.5%
            }
            return baseProb; // 기본 확률
        }

        // =======================================================
        // V0 (구 버전) 게임 로직
        // =======================================================

        // v0 상태 변수
        let v0_userCash = 1000000;
        let v0_userCubes = 0;
        let v0_currentPrice = 100000;
        let v0_transactions = [];
        let v0_lastPrice = 100000;
        let v0_isCubePurchased = false;
        let v0_usedCodes = []; // v0용 사용된 코드 배열

        // v0 3D 변수
        let v0_scene, v0_camera, v0_renderer, v0_cube, v0_cubeMaterial;
        
        // v0 차트 변수
        let v0_chartInstance = null;
        let v0_priceHistory = { labels: [], data: [] };

        // v0 DOM 요소
        let v0_cashDisplay, v0_cubesDisplay, v0_priceDisplay, v0_priceChangeDisplay, v0_amountInput, 
            v0_buyButton, v0_sellButton, v0_newsFeed, v0_transactionHistory, v0_notification, 
            v0_buyCubeButton, v0_cubeOverlay, v0_canvasContainer,
            v0_codeInput, v0_codeSubmitButton; // v0 코드 입력 DOM

        function initV0Game() {
            console.log("Initializing v0 Game...");
            // v0 DOM 요소 할당
            v0_canvasContainer = document.getElementById('v0-canvas-container');
            v0_cashDisplay = document.getElementById('v0-user-cash');
            v0_cubesDisplay = document.getElementById('v0-user-cubes');
            v0_priceDisplay = document.getElementById('v0-current-price');
            v0_priceChangeDisplay = document.getElementById('v0-price-change');
            v0_amountInput = document.getElementById('v0-amount-input');
            v0_buyButton = document.getElementById('v0-buy-button');
            v0_sellButton = document.getElementById('v0-sell-button');
            v0_newsFeed = document.getElementById('v0-news-feed');
            v0_transactionHistory = document.getElementById('v0-transaction-history');
            v0_notification = document.getElementById('v0-notification');
            v0_buyCubeButton = document.getElementById('v0-buy-cube-button');
            v0_cubeOverlay = document.getElementById('v0-cube-purchase-overlay');
            v0_codeInput = document.getElementById('v0-code-input'); // v0 코드 DOM 할당
            v0_codeSubmitButton = document.getElementById('v0-code-submit-button'); // v0 코드 DOM 할당

            // v0 이벤트 리스너
            v0_buyButton.addEventListener('click', v0_handleBuy);
            v0_sellButton.addEventListener('click', v0_handleSell);
            v0_buyCubeButton.addEventListener('click', v0_handleBuyCube);
            v0_codeSubmitButton.addEventListener('click', v0_handleCodeSubmit); // v0 코드 제출 리스너

            // v0 초기화
            v0_initThree();
            v0_initChart();
            v0_updateUI();
            v0_updateTransactionHistory();
            
            // v0 3초마다 가격 업데이트
            setInterval(v0_updatePrice, 3000);
        }

        // --- v0 3D 로직 ---
        function v0_initThree() {
            v0_scene = new THREE.Scene();
            v0_camera = new THREE.PerspectiveCamera(75, v0_canvasContainer.clientWidth / v0_canvasContainer.clientHeight, 0.1, 1000);
            v0_camera.position.z = 5;

            v0_renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            v0_renderer.setSize(v0_canvasContainer.clientWidth, v0_canvasContainer.clientHeight);
            v0_renderer.setPixelRatio(window.devicePixelRatio);
            v0_canvasContainer.prepend(v0_renderer.domElement); 

            const geometry = new THREE.BoxGeometry(2.5, 2.5, 2.5);
            v0_cubeMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x60a5fa, metalness: 0.5, roughness: 0.1 
            });
            v0_cube = new THREE.Mesh(geometry, v0_cubeMaterial);
            
            const wireframeGeometry = new THREE.EdgesGeometry(v0_cube.geometry);
            const wireframeMaterial = new THREE.LineBasicMaterial({ color: 0xffffff, linewidth: 2 });
            v0_cube.add(new THREE.LineSegments(wireframeGeometry, wireframeMaterial));
            v0_scene.add(v0_cube);

            v0_scene.add(new THREE.AmbientLight(0xffffff, 0.5));
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight.position.set(5, 5, 5);
            v0_scene.add(directionalLight);

            window.addEventListener('resize', v0_onWindowResize, false);
            v0_animate();
        }

        function v0_animate() {
            requestAnimationFrame(v0_animate);
            if (v0_isCubePurchased && v0_cube) {
                v0_cube.rotation.x += 0.005;
                v0_cube.rotation.y += 0.005;
            }
            if (v0_renderer) {
                v0_renderer.render(v0_scene, v0_camera);
            }
        }

        function v0_onWindowResize() {
            if (v0_canvasContainer && v0_renderer) {
                v0_camera.aspect = v0_canvasContainer.clientWidth / v0_canvasContainer.clientHeight;
                v0_camera.updateProjectionMatrix();
                v0_renderer.setSize(v0_canvasContainer.clientWidth, v0_canvasContainer.clientHeight);
            }
        }

        function v0_flashCubeColor(color) {
            if (!v0_isCubePurchased || !v0_cubeMaterial) return;
            v0_cubeMaterial.color.set(color);
            setTimeout(() => {
                if (v0_cubeMaterial) v0_cubeMaterial.color.set(0x60a5fa);
            }, 500);
        }

        // --- v0 차트 로직 ---
        function v0_initChart() {
            const ctx = document.getElementById('v0-price-chart').getContext('2d');
            if (!ctx) return;
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(96, 165, 250, 0.5)');
            gradient.addColorStop(1, 'rgba(96, 165, 250, 0)');

            v0_chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: v0_priceHistory.labels,
                    datasets: [{
                        label: 'CUBE 가격',
                        data: v0_priceHistory.data,
                        borderColor: '#60a5fa',
                        backgroundColor: gradient,
                        fill: true, tension: 0.4, pointRadius: 0,
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        x: { display: false },
                        y: { ticks: { color: '#9ca3af' }, grid: { color: '#4b5563' } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function v0_updateChart() {
            const time = new Date().toLocaleTimeString('ko-KR').split(' ')[1] || new Date().toLocaleTimeString('ko-KR');
            v0_priceHistory.labels.push(time);
            v0_priceHistory.data.push(v0_currentPrice);
            if (v0_priceHistory.labels.length > 20) {
                v0_priceHistory.labels.shift();
                v0_priceHistory.data.shift();
            }
            if (v0_chartInstance) {
                v0_chartInstance.update('none');
            }
        }

        // --- v0 UI 및 게임 로직 ---
        function v0_updateUI() {
            if (!v0_cashDisplay) return;
            v0_cashDisplay.textContent = v0_userCash.toLocaleString('ko-KR');
            v0_cubesDisplay.textContent = v0_userCubes.toLocaleString('ko-KR');
            v0_priceDisplay.textContent = `${v0_currentPrice.toLocaleString('ko-KR')} KRW`;
            
            const change = v0_currentPrice - v0_lastPrice;
            const changePercent = v0_lastPrice > 0 ? ((change / v0_lastPrice) * 100).toFixed(2) : 0;
            
            if (change > 0) v0_priceChangeDisplay.innerHTML = `<span class="text-green-500">▲ ${change.toLocaleString('ko-KR')} (+${changePercent}%)</span>`;
            else if (change < 0) v0_priceChangeDisplay.innerHTML = `<span class="text-red-500">▼ ${Math.abs(change).toLocaleString('ko-KR')} (${changePercent}%)</span>`;
            else v0_priceChangeDisplay.innerHTML = `<span class="text-gray-400">0 (0.00%)</span>`;
        }

        function v0_updateTransactionHistory() {
            if (!v0_transactionHistory) return;
            if (v0_transactions.length === 0) {
                v0_transactionHistory.innerHTML = '<div class="text-gray-400 text-sm text-center p-4">거래 내역이 없습니다.</div>';
                return;
            }
            v0_transactionHistory.innerHTML = '';
            v0_transactions.slice(-100).forEach(tx => {
                const txElement = document.createElement('div');
                txElement.className = 'border-b border-gray-600 p-2 text-sm';
                const typeClass = tx.type === '매수' ? 'text-green-400' : 'text-red-400';
                txElement.innerHTML = `<div><span class="${typeClass} font-bold">[${tx.type}]</span> ${tx.amount.toLocaleString('ko-KR')} CUBE</div><div class="text-xs text-gray-400">체결가: ${tx.price.toLocaleString('ko-KR')} KRW | ${new Date(tx.timestamp).toLocaleTimeString('ko-KR')}</div>`;
                v0_transactionHistory.prepend(txElement);
            });
        }

        function v0_generateNews(changePercent) {
            const positiveNews = ["[속보] 큐브 체인, 대형 테크 기업과 파트너십 체결!", "[호재] 기관 투자자, 큐브 코인 대량 매집 시작"];
            const negativeNews = ["[속보] 큐브 코인, 치명적 보안 취약점 발견 루머", "[악재] 주요 거래소, 큐브 코인 상장 폐지 검토"];
            let news = '';
            if (changePercent > 0.05) news = positiveNews[Math.floor(Math.random() * positiveNews.length)];
            else if (changePercent < -0.05) news = negativeNews[Math.floor(Math.random() * negativeNews.length)];
            else return; 

            const newsElement = document.createElement('div');
            newsElement.className = 'border-b border-gray-600 p-2 text-sm text-blue-200';
            newsElement.textContent = news;
            if (v0_newsFeed.children.length === 1 && v0_newsFeed.children[0].textContent.includes('기다립니다')) v0_newsFeed.innerHTML = '';
            v0_newsFeed.prepend(newsElement);
            if (v0_newsFeed.children.length > 10) v0_newsFeed.removeChild(v0_newsFeed.lastChild);
        }

        function v0_showNotification(message, isError = true) {
            if (!v0_notification) return;
            v0_notification.textContent = message;
            v0_notification.className = `fixed bottom-6 right-6 text-white p-4 rounded-lg shadow-xl transition-all duration-300 z-50 ${isError ? 'bg-red-500' : 'bg-green-500'} opacity-100 translate-y-0`;
            setTimeout(() => {
                v0_notification.classList.add('opacity-0', 'translate-y-10');
            }, 3000);
        }

        function v0_getPriceChange() {
            // *** 동적 확률 적용 ***
            const riseProb = getDynamicRiseProbability(0.55, getCurrentTime(), UPDATE_TIME);
            let direction = Math.random() < riseProb ? 1 : -1;
            
            let magnitudeRand = Math.random();
            let changePercent;
            if (magnitudeRand < 0.60) changePercent = (Math.random() * 0.01) + 0.001;
            else if (magnitudeRand < 0.90) changePercent = (Math.random() * 0.04) + 0.011;
            else changePercent = (Math.random() * 0.1) + 0.051;
            
            const priceChange = v0_currentPrice * changePercent * direction;
            return { priceChange, changePercent: changePercent * direction };
        }

        function v0_updatePrice() {
            v0_lastPrice = v0_currentPrice;
            const { priceChange, changePercent } = v0_getPriceChange();
            v0_currentPrice = Math.max(1000, v0_currentPrice + priceChange);
            v0_currentPrice = Math.round(v0_currentPrice);
            v0_updateUI();
            v0_generateNews(changePercent);
            v0_updateChart();
            if (changePercent > 0) v0_flashCubeColor(0x00ff00);
            else if (changePercent < 0) v0_flashCubeColor(0xff0000);
        }

        function v0_getAmount() {
            if (!v0_amountInput) return 0;
            const amount = parseInt(v0_amountInput.value, 10);
            if (isNaN(amount) || amount <= 0) {
                v0_showNotification('유효한 수량을 입력하세요.', true);
                return 0;
            }
            return amount;
        }

        function v0_handleBuy() {
            const amount = v0_getAmount();
            if (amount === 0) return;
            const totalCost = v0_currentPrice * amount;
            if (v0_userCash >= totalCost) {
                v0_userCash -= totalCost;
                v0_userCubes += amount;
                v0_transactions.push({ type: '매수', amount: amount, price: v0_currentPrice, timestamp: Date.now() });
                v0_updateUI();
                v0_updateTransactionHistory();
                v0_showNotification(`${amount.toLocaleString('ko-KR')} CUBE 매수 완료!`, false);
                v0_saveGameState();
            } else {
                v0_showNotification('보유 현금이 부족합니다.', true);
            }
        }

        function v0_handleSell() {
            const amount = v0_getAmount();
            if (amount === 0) return;
            if (v0_userCubes >= amount) {
                v0_userCash += (v0_currentPrice * amount);
                v0_userCubes -= amount;
                v0_transactions.push({ type: '매도', amount: amount, price: v0_currentPrice, timestamp: Date.now() });
                v0_updateUI();
                v0_updateTransactionHistory();
                v0_showNotification(`${amount.toLocaleString('ko-KR')} CUBE 매도 완료!`, false);
                v0_saveGameState();
            } else {
                v0_showNotification('보유한 큐브 코인이 부족합니다.', true);
            }
        }

        // v0 코드 제출 핸들러 (신규 추가)
        function v0_handleCodeSubmit() {
            if (!v0_codeInput) return;
            const code = v0_codeInput.value.trim();
            if (code === '') return;

            // *** v0용 개발자 코드 (신규 추가) ***
            if (code === 'ice_v.0.2.2') {
                sessionStorage.setItem('devTestTime', '2025-11-14T17:59:00+09:00'); // 1분 전
                v0_showNotification('개발자 모드: 1분 전으로 시간 이동... 새로고침합니다.', false);
                setTimeout(() => location.reload(), 1000);
                return;
            }
            // *****************

            if (v0_usedCodes.includes(code)) {
                v0_showNotification('이미 사용된 코드입니다.', true);
                return;
            }

            if (code === 'Release') {
                v0_userCash += 10000;
                v0_showNotification('Release 코드! 10,000 KRW를 획득했습니다!', false);
                v0_usedCodes.push(code);
            } else if (code === 'PRISM') {
                // v0에는 프리즘이 없으므로 현금 10만 KRW 대체 지급
                v0_userCash += 100000; 
                v0_showNotification('PRISM 코드! v0에서는 100,000 KRW가 지급됩니다!', false);
                v0_usedCodes.push(code);
            } else if (code === 'ice_cube102') {
                v0_userCash += 10000000000000; // 10조
                v0_showNotification('개발자 코드! 10조 KRW를 획득했습니다!', false);
                v0_usedCodes.push(code);
            } else {
                v0_showNotification('유효하지 않은 코드입니다.', true);
            }
            
            if (v0_codeInput) v0_codeInput.value = '';
            v0_updateUI();
            v0_saveGameState();
        }

        function v0_handleBuyCube() {
            const cubePrice = 10000000;
            if (v0_userCash >= cubePrice) {
                v0_userCash -= cubePrice;
                v0_isCubePurchased = true;
                v0_cubeOverlay.style.display = 'none';
                v0_updateUI();
                v0_showNotification('3D 큐브 회전이 활성화되었습니다!', false);
                v0_saveGameState();
            } else {
                v0_showNotification('3D 큐브를 구매할 현금이 부족합니다. (필요: 1천만 KRW)', true);
            }
        }

        // --- v0 Firebase 로직 ---
        function v0_saveGameState() {
            if (!db || !userId || !appId) return;
            const gameState = {
                userCash: v0_userCash,
                userCubes: v0_userCubes,
                transactions: v0_transactions,
                isCubePurchased: v0_isCubePurchased,
                usedCodes: v0_usedCodes // v0 사용 코드 저장
            };
            if (window.setDoc && window.doc) {
                const docRef = window.doc(db, "artifacts", appId, "users", userId, "simulator_state", "game_data"); // v0 전용 경로
                window.setDoc(docRef, gameState).catch(e => console.error("Error saving v0 state: ", e));
            }
        }

        function v0_loadGameState(docSnap) {
            if (docSnap.exists()) {
                console.log("Loading v0 saved data...");
                const data = docSnap.data();
                v0_userCash = data.userCash;
                v0_userCubes = data.userCubes;
                v0_transactions = data.transactions || [];
                v0_isCubePurchased = data.isCubePurchased;
                v0_usedCodes = data.usedCodes || []; // v0 사용 코드 불러오기
                
                v0_updateUI();
                v0_updateTransactionHistory();
                if (v0_isCubePurchased) {
                    v0_cubeOverlay.style.display = 'none';
                }
            } else {
                console.log("No v0 data found. Saving initial v0 state.");
                v0_saveGameState(); 
            }
        }


        // =======================================================
        // V2 (신 버전 v.0.2.2) 게임 로직
        // =======================================================

        // v2 상태 변수
        let v2_userCash = 100000;
        let v2_userCubes = 0;
        let v2_userPrisms = 0;
        let v2_currentPrice = 10000;
        let v2_lastPrice = 10000;
        let v2_currentPrismPrice = 50000;
        let v2_lastPrismPrice = 50000;
        let v2_transactions = [];
        let v2_isCubePurchased = false; 
        let v2_isPrismUpgraded = false;
        let v2_usedCodes = [];
        let v2_paperCooldown = false;
        let v2_paperClicks = 0;
        let v2_achievedPaperNovice = false;
        let v2_achievedPaperPro = false;
        let v2_achievedPaperMaster = false;
        let v2_paperIncome = 500;
        let v2_paperCooldownTime = 2000;

        // v2 3D 변수
        let v2_scene, v2_camera, v2_renderer, v2_cube, v2_cubeMaterial;

        // v2 차트 변수
        let v2_cubeChartInstance = null;
        let v2_prismChartInstance = null;
        let v2_cubePriceHistory = { labels: [], data: [] };
        let v2_prismPriceHistory = { labels: [], data: [] };

        // v2 DOM 요소 (너무 많아서 init에서 선언)
        let v2_dom = {}; 

        function initV2Game() {
            console.log("Initializing v2 Game...");
            // v2 DOM 요소 할당
            v2_dom.canvasContainer = document.getElementById('v2-canvas-container');
            v2_dom.cashDisplay = document.getElementById('v2-user-cash');
            v2_dom.cubesDisplay = document.getElementById('v2-user-cubes');
            v2_dom.prismsDisplay = document.getElementById('v2-user-prisms');
            v2_dom.priceDisplay = document.getElementById('v2-current-price');
            v2_dom.priceChangeDisplay = document.getElementById('v2-price-change');
            v2_dom.prismPriceDisplay = document.getElementById('v2-current-prism-price');
            v2_dom.prismPriceChangeDisplay = document.getElementById('v2-prism-price-change');
            
            v2_dom.amountInputCube = document.getElementById('v2-amount-input-cube');
            v2_dom.buyButtonCube = document.getElementById('v2-buy-button-cube');
            v2_dom.sellButtonCube = document.getElementById('v2-sell-button-cube');
            v2_dom.amountInputPrism = document.getElementById('v2-amount-input-prism');
            v2_dom.buyButtonPrism = document.getElementById('v2-buy-button-prism');
            v2_dom.sellButtonPrism = document.getElementById('v2-sell-button-prism');
            
            v2_dom.newsFeed = document.getElementById('v2-news-feed');
            v2_dom.transactionHistory = document.getElementById('v2-transaction-history');
            v2_dom.notification = document.getElementById('v2-notification');
            
            v2_dom.buyCubeButton = document.getElementById('v2-buy-cube-button');
            v2_dom.cubeOverlay = document.getElementById('v2-cube-purchase-overlay');
            v2_dom.upgradePrismSection = document.getElementById('v2-upgrade-prism-section');
            v2_dom.upgradePrismButton = document.getElementById('v2-upgrade-prism-button');
            
            v2_dom.jobPaper = document.getElementById('v2-job-paper');
            v2_dom.jobPaperTimer = document.getElementById('v2-job-paper-timer');
            
            v2_dom.codeInput = document.getElementById('v2-code-input');
            v2_dom.codeSubmitButton = document.getElementById('v2-code-submit-button');
            
            v2_dom.passiveIncomeDisplay = document.getElementById('v2-passive-income-display');
            v2_dom.incomePerSecond = document.getElementById('v2-income-per-second');
            
            v2_dom.chartTabCube = document.getElementById('v2-chart-tab-cube');
            v2_dom.chartTabPrism = document.getElementById('v2-chart-tab-prism');
            v2_dom.chartCubeContainer = document.getElementById('v2-chart-cube-container');
            v2_dom.chartPrismContainer = document.getElementById('v2-chart-prism-container');

            // v2 이벤트 리스너
            v2_dom.buyButtonCube.addEventListener('click', v2_handleBuyCube);
            v2_dom.sellButtonCube.addEventListener('click', v2_handleSellCube);
            v2_dom.buyButtonPrism.addEventListener('click', v2_handleBuyPrism);
            v2_dom.sellButtonPrism.addEventListener('click', v2_handleSellPrism);
            v2_dom.buyCubeButton.addEventListener('click', v2_handleBuy3DCube);
            v2_dom.upgradePrismButton.addEventListener('click', v2_handleUpgradePrism);
            v2_dom.jobPaper.addEventListener('click', () => v2_handleJobClick('paper'));
            v2_dom.codeSubmitButton.addEventListener('click', v2_handleCodeSubmit);
            
            // 탭 리스너
            v2_dom.chartTabCube.addEventListener('click', () => {
                v2_dom.chartTabCube.classList.add('tab-active');
                v2_dom.chartTabPrism.classList.remove('tab-active');
                v2_dom.chartCubeContainer.classList.remove('hidden');
                v2_dom.chartPrismContainer.classList.add('hidden');
            });
            v2_dom.chartTabPrism.addEventListener('click', () => {
                v2_dom.chartTabPrism.classList.add('tab-active');
                v2_dom.chartTabCube.classList.remove('tab-active');
                v2_dom.chartPrismContainer.classList.remove('hidden');
                v2_dom.chartCubeContainer.classList.add('hidden');
            });
            
            // 토글 리스너
            v2_setupSectionToggle('v2-toggle-assets', 'v2-content-assets', 'v2-toggle-assets-icon');
            v2_setupSectionToggle('v2-toggle-trade', 'v2-content-trade', 'v2-toggle-trade-icon');
            v2_setupSectionToggle('v2-toggle-charts', 'v2-content-charts', 'v2-toggle-charts-icon');
            v2_setupSectionToggle('v2-toggle-history', 'v2-content-history', 'v2-toggle-history-icon');
            v2_setupSectionToggle('v2-toggle-news', 'v2-content-news', 'v2-toggle-news-icon');
            v2_setupSectionToggle('v2-toggle-jobs', 'v2-content-jobs', 'v2-toggle-jobs-icon');
            v2_setupSectionToggle('v2-toggle-code', 'v2-content-code', 'v2-toggle-code-icon');
            v2_setupSectionToggle('v2-toggle-updates', 'v2-content-updates', 'v2-toggle-updates-icon');

            // v2 초기화
            v2_initThree();
            v2_cubeChartInstance = v2_initChart('v2-price-chart', v2_cubePriceHistory, '#60a5fa');
            v2_prismChartInstance = v2_initChart('v2-prism-price-chart', v2_prismPriceHistory, '#f472b6');
            
            v2_calculatePaperStats(); // 폐지 줍기 스탯 계산
            v2_updateUI();
            v2_updateTransactionHistory();
            
            v2_gameLoop(); // v2 게임 루프 시작
        }

        // --- v2 3D 로직 ---
        function v2_initThree() {
            v2_scene = new THREE.Scene();
            v2_camera = new THREE.PerspectiveCamera(75, v2_dom.canvasContainer.clientWidth / v2_dom.canvasContainer.clientHeight, 0.1, 1000);
            v2_camera.position.z = 5;

            v2_renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            v2_renderer.setSize(v2_dom.canvasContainer.clientWidth, v2_dom.canvasContainer.clientHeight);
            v2_renderer.setPixelRatio(window.devicePixelRatio);
            v2_dom.canvasContainer.prepend(v2_renderer.domElement); 

            const geometry = new THREE.BoxGeometry(2.5, 2.5, 2.5);
            v2_cubeMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x60a5fa, metalness: 0.5, roughness: 0.1 
            });
            v2_cube = new THREE.Mesh(geometry, v2_cubeMaterial);
            
            const wireframeGeometry = new THREE.EdgesGeometry(v2_cube.geometry);
            const wireframeMaterial = new THREE.LineBasicMaterial({ color: 0xffffff, linewidth: 2 });
            v2_cube.add(new THREE.LineSegments(wireframeGeometry, wireframeMaterial));
            v2_scene.add(v2_cube);

            v2_scene.add(new THREE.AmbientLight(0xffffff, 0.7));
            const light = new THREE.DirectionalLight(0xffffff, 1);
            light.position.set(5, 5, 5);
            v2_scene.add(light);

            window.addEventListener('resize', v2_onWindowResize, false);
            v2_animate();
        }

        function v2_upgradeToPrismMaterial() {
            if (!v2_cubeMaterial) return;
            v2_cubeMaterial.color.set(0xf472b6);
            v2_cubeMaterial.metalness = 0.2;
            v2_cubeMaterial.roughness = 0;
            v2_cubeMaterial.transmission = 1.0;
            v2_cubeMaterial.ior = 1.5;
            v2_cubeMaterial.thickness = 1.0; 
            v2_isPrismUpgraded = true;
        }

        let v2_lastIncomeTime = Date.now();
        function v2_animate() {
            requestAnimationFrame(v2_animate);
            if (v2_isCubePurchased && v2_cube) {
                v2_cube.rotation.x += 0.005;
                v2_cube.rotation.y += 0.005;
            }
            
            const now = Date.now();
            if (now - v2_lastIncomeTime > 1000 && (v2_isCubePurchased || v2_isPrismUpgraded)) {
                let income = v2_isPrismUpgraded ? 200 : (v2_isCubePurchased ? 100 : 0);
                if (income > 0) {
                    v2_userCash += income;
                    if (v2_dom.cashDisplay) v2_dom.cashDisplay.textContent = v2_userCash.toLocaleString('ko-KR');
                }
                v2_lastIncomeTime = now;
            }

            if (v2_renderer) v2_renderer.render(v2_scene, v2_camera);
        }

        function v2_onWindowResize() {
            if (v2_dom.canvasContainer && v2_renderer) {
                v2_camera.aspect = v2_dom.canvasContainer.clientWidth / v2_dom.canvasContainer.clientHeight;
                v2_camera.updateProjectionMatrix();
                v2_renderer.setSize(v2_dom.canvasContainer.clientWidth, v2_dom.canvasContainer.clientHeight);
            }
        }

        function v2_flashObjectColor(color) {
            if (!v2_isCubePurchased || !v2_cubeMaterial) return;
            const originalColor = v2_isPrismUpgraded ? 0xf472b6 : 0x60a5fa;
            v2_cubeMaterial.color.set(color);
            setTimeout(() => {
                if (v2_cubeMaterial) v2_cubeMaterial.color.set(originalColor);
            }, 500); 
        }

        // --- v2 차트 로직 ---
        function v2_initChart(canvasId, historyObject, color) {
            const ctx = document.getElementById(canvasId)?.getContext('2d');
            if (!ctx) return null;
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, `${color}80`);
            gradient.addColorStop(1, `${color}00`);
            return new Chart(ctx, {
                type: 'line', data: { labels: historyObject.labels, datasets: [{
                    label: '가격', data: historyObject.data, borderColor: color,
                    backgroundColor: gradient, fill: true, tension: 0.4, pointRadius: 0,
                }]},
                options: { responsive: true, maintainAspectRatio: false,
                    scales: { x: { display: false }, y: { ticks: { color: '#9ca3af' }, grid: { color: '#4b5563' } } },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function v2_updateChart(instance, historyObject, newPrice) {
            const time = new Date().toLocaleTimeString('ko-KR').split(' ')[1] || new Date().toLocaleTimeString('ko-KR');
            historyObject.labels.push(time);
            historyObject.data.push(newPrice);
            if (historyObject.labels.length > 20) {
                historyObject.labels.shift();
                historyObject.data.shift();
            }
            if (instance) instance.update('none');
        }

        // --- v2 UI 및 게임 로직 ---
        function v2_updateUI() {
            if (!v2_dom.cashDisplay) return;
            v2_dom.cashDisplay.textContent = v2_userCash.toLocaleString('ko-KR');
            v2_dom.cubesDisplay.textContent = v2_userCubes.toLocaleString('ko-KR');
            v2_dom.prismsDisplay.textContent = v2_userPrisms.toLocaleString('ko-KR');
            
            v2_dom.priceDisplay.textContent = `${v2_currentPrice.toLocaleString('ko-KR')} KRW`;
            const change = v2_currentPrice - v2_lastPrice;
            const changePercent = v2_lastPrice > 0 ? ((change / v2_lastPrice) * 100).toFixed(2) : 0;
            v2_dom.priceChangeDisplay.innerHTML = v2_formatPriceChange(change, changePercent);
            
            v2_dom.prismPriceDisplay.textContent = `${v2_currentPrismPrice.toLocaleString('ko-KR')} KRW`;
            const prismChange = v2_currentPrismPrice - v2_lastPrismPrice;
            const prismChangePercent = v2_lastPrismPrice > 0 ? ((prismChange / v2_lastPrismPrice) * 100).toFixed(2) : 0;
            v2_dom.prismPriceChangeDisplay.innerHTML = v2_formatPriceChange(prismChange, prismChangePercent);
            
            if (v2_isPrismUpgraded) {
                v2_dom.cubeOverlay.style.display = 'none';
                v2_dom.upgradePrismSection.classList.add('hidden');
                v2_dom.passiveIncomeDisplay.classList.remove('hidden');
                v2_dom.incomePerSecond.textContent = '+200 KRW / sec';
            } else if (v2_isCubePurchased) {
                v2_dom.cubeOverlay.style.display = 'none';
                v2_dom.upgradePrismSection.classList.remove('hidden');
                v2_dom.passiveIncomeDisplay.classList.remove('hidden');
                v2_dom.incomePerSecond.textContent = '+100 KRW / sec';
            } else {
                v2_dom.cubeOverlay.style.display = 'flex';
                v2_dom.upgradePrismSection.classList.add('hidden');
                v2_dom.passiveIncomeDisplay.classList.add('hidden');
            }
        }
        
        function v2_formatPriceChange(change, percent) {
            if (change > 0) return `<span class="text-green-500">▲ ${change.toLocaleString('ko-KR')} (+${percent}%)</span>`;
            if (change < 0) return `<span class="text-red-500">▼ ${Math.abs(change).toLocaleString('ko-KR')} (${percent}%)</span>`;
            return `<span class="text-gray-400">0 (0.00%)</span>`;
        }

        function v2_updateTransactionHistory() {
            if (!v2_dom.transactionHistory) return;
            if (v2_transactions.length === 0) {
                v2_dom.transactionHistory.innerHTML = '<div class="text-gray-400 text-sm text-center p-4">거래 내역이 없습니다.</div>';
                return;
            }
            v2_dom.transactionHistory.innerHTML = '';
            v2_transactions.slice(-100).forEach(tx => {
                const txElement = document.createElement('div');
                txElement.className = 'border-b border-gray-600 p-2 text-sm';
                const typeClass = tx.type === '매수' ? 'text-green-400' : 'text-red-400';
                txElement.innerHTML = `<div><span class="${typeClass} font-bold">[${tx.type}]</span> ${tx.amount.toLocaleString('ko-KR')} ${tx.coin}</div><div class="text-xs text-gray-400">체결가: ${tx.price.toLocaleString('ko-KR')} KRW | ${new Date(tx.timestamp).toLocaleTimeString('ko-KR')}</div>`;
                v2_dom.transactionHistory.prepend(txElement);
            });
        }
        
        function v2_generateNews(news) {
            if (!v2_dom.newsFeed) return;
            const newsElement = document.createElement('div');
            let textColor = 'text-blue-200';
            if (news.includes("급등") || news.includes("호재")) textColor = 'text-green-300';
            if (news.includes("급락") || news.includes("악재")) textColor = 'text-red-300';
            newsElement.className = `border-b border-gray-600 p-2 text-sm ${textColor}`;
            newsElement.textContent = `[${new Date().toLocaleTimeString('ko-KR')}] ${news}`;
            if (v2_dom.newsFeed.children.length === 1 && v2_dom.newsFeed.children[0].textContent.includes('기다립니다')) v2_dom.newsFeed.innerHTML = '';
            v2_dom.newsFeed.prepend(newsElement);
            if (v2_dom.newsFeed.children.length > 10) v2_dom.newsFeed.removeChild(v2_dom.newsFeed.lastChild);
        }
        
        function v2_showNotification(message, isError = true) {
            if (!v2_dom.notification) return;
            v2_dom.notification.textContent = message;
            v2_dom.notification.className = `fixed bottom-6 right-6 text-white p-4 rounded-lg shadow-xl transition-all duration-300 z-50 ${isError ? 'bg-red-500' : 'bg-green-500'} opacity-100 translate-y-0`;
            setTimeout(() => {
                v2_dom.notification.classList.add('opacity-0', 'translate-y-10');
            }, 3000);
        }

        function v2_getPriceChange(coinType) {
            let direction, magnitudeRand, changePercent, ratios, baseProb, price;
            
            if (coinType === 'CUBE') {
                baseProb = getDynamicRiseProbability(0.52, getCurrentTime(), UPDATE_TIME);
                direction = Math.random() < baseProb ? 1 : -1;
                ratios = { small: 0.50, medium: 0.95 };
                price = v2_currentPrice;
            } else { // PRISM
                baseProb = getDynamicRiseProbability(0.51, getCurrentTime(), UPDATE_TIME);
                direction = Math.random() < baseProb ? 1 : -1;
                ratios = { small: 0.60, medium: 0.98 };
                price = v2_currentPrismPrice;
            }

            magnitudeRand = Math.random();
            let magnitude;
            if (magnitudeRand < ratios.small) { magnitude = 'small'; changePercent = (Math.random() * 0.01) + 0.001; }
            else if (magnitudeRand < ratios.medium) { magnitude = 'medium'; changePercent = (Math.random() * 0.04) + 0.011; }
            else { magnitude = 'large'; changePercent = (Math.random() * 0.1) + 0.051; }
            
            const priceChange = price * changePercent * direction;
            return { priceChange, magnitude, direction, coinType };
        }
        
        function v2_decideNextEvent() {
            const coinType = Math.random() < 0.5 ? 'CUBE' : 'PRISM';
            const { priceChange, magnitude, direction } = v2_getPriceChange(coinType);
            let newsText = "", coinName = coinType === 'CUBE' ? '큐브' : '프리즘';
            if (direction > 0) {
                if (magnitude === 'large') newsText = `[속보] ${coinName} 코인, 대형 호재 발표! 잠시 후 가격 급등이 예상됩니다!`;
                else if (magnitude === 'medium') newsText = `[정보] ${coinName} 코인, 기관 매수세 유입... 곧 완만한 상승이 시작될 듯.`;
                else newsText = `[분석] ${coinName} 코인, 단기 저점 확인... 소폭 반등 예상.`;
            } else {
                if (magnitude === 'large') newsText = `[속보] ${coinName} 코인, 대형 악재 발생! 잠시 후 가격 급락이 예상됩니다!`;
                else if (magnitude === 'medium') newsText = `[경고] ${coinName} 코인, 투자 심리 위축... 조정 장세 돌입 예상.`;
                else newsText = `[분석] ${coinName} 코인, 차익 실현 매물 출회... 소폭 하락 예상.`;
            }
            return { coinType, priceChange, newsText, direction };
        }
        
        function v2_applyPriceChange(coinType, priceChange, direction) {
            if (coinType === 'CUBE') {
                v2_lastPrice = v2_currentPrice;
                v2_currentPrice = Math.max(1000, v2_currentPrice + priceChange);
                v2_currentPrice = Math.round(v2_currentPrice);
                v2_updateChart(v2_cubeChartInstance, v2_cubePriceHistory, v2_currentPrice);
                v2_flashObjectColor(direction > 0 ? 0x86efac : 0xfca5a5);
            } else {
                v2_lastPrismPrice = v2_currentPrismPrice;
                v2_currentPrismPrice = Math.max(500, v2_currentPrismPrice + priceChange);
                v2_currentPrismPrice = Math.round(v2_currentPrismPrice);
                v2_updateChart(v2_prismChartInstance, v2_prismPriceHistory, v2_currentPrismPrice);
                v2_flashObjectColor(direction > 0 ? 0x86efac : 0xfca5a5);
            }
            v2_updateUI();
        }

        function v2_gameLoop() {
            const { coinType, priceChange, newsText, direction } = v2_decideNextEvent();
            v2_generateNews(newsText);
            setTimeout(() => { v2_applyPriceChange(coinType, priceChange, direction); }, 5000);
            const nextLoopTime = Math.random() * 5000 + 10000;
            setTimeout(v2_gameLoop, nextLoopTime);
        }

        function v2_getAmount(inputId) {
            const input = document.getElementById(inputId);
            if (!input) return 0;
            const amount = parseInt(input.value, 10);
            if (isNaN(amount) || amount <= 0) {
                v2_showNotification('유효한 수량을 입력하세요.', true);
                return 0;
            }
            return amount;
        }
        
        function v2_calculatePaperStats() {
            v2_paperIncome = 500; v2_paperCooldownTime = 2000;
            if (v2_achievedPaperNovice) { v2_paperCooldownTime -= 500; v2_paperIncome = 500 * 2; }
            if (v2_achievedPaperPro) { v2_paperCooldownTime -= 500; v2_paperIncome = 500 * 3; }
            if (v2_achievedPaperMaster) { v2_paperCooldownTime -= 200; v2_paperIncome = 500 * 5; }
            if (v2_dom.jobPaper) {
                v2_dom.jobPaper.innerHTML = `폐지 줍기 (+${v2_paperIncome.toLocaleString('ko-KR')}) <span id="v2-job-paper-timer" class="text-xs block"></span>`;
                v2_dom.jobPaperTimer = document.getElementById('v2-job-paper-timer');
            }
        }
        
        function v2_checkPaperAchievements() {
            let unlocked = false;
            if (!v2_achievedPaperNovice && v2_paperClicks >= 10) { unlocked = true; v2_achievedPaperNovice = true; v2_showNotification("발전과제: 폐지 줍기 중수 달성! (쿨타임 -0.5초, 수입 2배)", false); }
            if (!v2_achievedPaperPro && v2_paperClicks >= 30) { unlocked = true; v2_achievedPaperPro = true; v2_showNotification("발전과제: 폐지 줍기 고수 달성! (쿨타임 -0.5초, 수입 총 3배)", false); }
            if (!v2_achievedPaperMaster && v2_paperClicks >= 100) { unlocked = true; v2_achievedPaperMaster = true; v2_showNotification("발전과제: 폐지 줍기 고인물 달성! (쿨타임 -0.2초, 수입 총 5배)", false); }
            if (unlocked) v2_calculatePaperStats();
        }

        function v2_handleJobClick(jobType) {
            if (jobType !== 'paper') return;
            v2_paperClicks++;
            v2_checkPaperAchievements();
            if (v2_paperCooldown) return v2_showNotification('폐지 줍기 쿨타임 중입니다.', true);
            v2_userCash += v2_paperIncome;
            v2_paperCooldown = true;
            v2_dom.jobPaper.classList.add('btn-disabled');
            let timer = v2_paperCooldownTime / 1000;
            v2_dom.jobPaperTimer.textContent = `(${timer.toFixed(1)}초)`;
            const interval = setInterval(() => {
                timer -= 0.1;
                if (timer > 0) v2_dom.jobPaperTimer.textContent = `(${timer.toFixed(1)}초)`;
                else {
                    clearInterval(interval);
                    v2_paperCooldown = false;
                    v2_dom.jobPaper.classList.remove('btn-disabled');
                    v2_dom.jobPaperTimer.textContent = '';
                }
            }, 100);
            v2_updateUI();
            v2_saveGameState();
        }
        
        function v2_handleCodeSubmit() {
            const code = v2_dom.codeInput.value.trim();
            if (code === '') return;
            
            // *** 개발자 코드 ***
            if (code === 'ice_v.0.2.2') {
                sessionStorage.setItem('devTestTime', '2025-11-14T17:59:00+09:00'); // 1분 전
                v2_showNotification('개발자 모드: 1분 전으로 시간 이동... 새로고침합니다.', false);
                setTimeout(() => location.reload(), 1000);
                return;
            }
            // *****************

            if (v2_usedCodes.includes(code)) {
                v2_showNotification('이미 사용된 코드입니다.', true);
                return;
            }
            if (code === 'PRISMUPDATE') {
                v2_userPrisms += 1;
                v2_showNotification('PRISM 1개를 획득했습니다!', false);
                v2_usedCodes.push(code);
                v2_dom.codeInput.value = '';
            } else if (code === 'ice_cube102') {
                v2_userCash += 10000000000000; // 10조
                v2_showNotification('개발자 코드! 10조 KRW를 획득했습니다!', false);
                v2_usedCodes.push(code);
                v2_dom.codeInput.value = '';
            } else if (code === 'Release') { // 신규 코드
                v2_userCash += 10000;
                v2_showNotification('Release 코드! 10,000 KRW를 획득했습니다!', false);
                v2_usedCodes.push(code);
                v2_dom.codeInput.value = '';
            } else if (code === 'PRISM') { // 신규 코드
                v2_userPrisms += 1;
                v2_showNotification('PRISM 1개를 획득했습니다!', false);
                v2_usedCodes.push(code);
                v2_dom.codeInput.value = '';
            } else {
                v2_showNotification('유효하지 않은 코드입니다.', true);
            }
            v2_updateUI();
            v2_saveGameState();
        }
        
        function v2_setupSectionToggle(btnId, contentId, iconId) {
            const btn = document.getElementById(btnId), content = document.getElementById(contentId), icon = document.getElementById(iconId);
            if (btn) btn.addEventListener('click', () => {
                content.classList.toggle('hidden');
                icon.classList.toggle('rotate-180');
            });
        }
        
        function v2_handleBuyCube() {
            const amount = v2_getAmount('v2-amount-input-cube');
            if (amount === 0) return;
            const totalCost = v2_currentPrice * amount;
            if (v2_userCash >= totalCost) {
                v2_userCash -= totalCost; v2_userCubes += amount;
                v2_transactions.push({ type: '매수', coin: 'CUBE', amount: amount, price: v2_currentPrice, timestamp: Date.now() });
                v2_updateUI(); v2_updateTransactionHistory();
                v2_showNotification(`${amount.toLocaleString('ko-KR')} CUBE 매수 완료!`, false);
                v2_saveGameState();
            } else v2_showNotification('보유 현금이 부족합니다.', true);
        }
        function v2_handleSellCube() {
            const amount = v2_getAmount('v2-amount-input-cube');
            if (amount === 0) return;
            if (v2_userCubes >= amount) {
                v2_userCash += (v2_currentPrice * amount); v2_userCubes -= amount;
                v2_transactions.push({ type: '매도', coin: 'CUBE', amount: amount, price: v2_currentPrice, timestamp: Date.now() });
                v2_updateUI(); v2_updateTransactionHistory();
                v2_showNotification(`${amount.toLocaleString('ko-KR')} CUBE 매도 완료!`, false);
                v2_saveGameState();
            } else v2_showNotification('보유한 큐브 코인이 부족합니다.', true);
        }
        function v2_handleBuyPrism() {
            const amount = v2_getAmount('v2-amount-input-prism');
            if (amount === 0) return;
            const totalCost = v2_currentPrismPrice * amount;
            if (v2_userCash >= totalCost) {
                v2_userCash -= totalCost; v2_userPrisms += amount;
                v2_transactions.push({ type: '매수', coin: 'PRISM', amount: amount, price: v2_currentPrismPrice, timestamp: Date.now() });
                v2_updateUI(); v2_updateTransactionHistory();
                v2_showNotification(`${amount.toLocaleString('ko-KR')} PRISM 매수 완료!`, false);
                v2_saveGameState();
            } else v2_showNotification('보유 현금이 부족합니다.', true);
        }
        function v2_handleSellPrism() {
            const amount = v2_getAmount('v2-amount-input-prism');
            if (amount === 0) return;
            if (v2_userPrisms >= amount) {
                v2_userCash += (v2_currentPrismPrice * amount); v2_userPrisms -= amount;
                v2_transactions.push({ type: '매도', coin: 'PRISM', amount: amount, price: v2_currentPrismPrice, timestamp: Date.now() });
                v2_updateUI(); v2_updateTransactionHistory();
                v2_showNotification(`${amount.toLocaleString('ko-KR')} PRISM 매도 완료!`, false);
                v2_saveGameState();
            } else v2_showNotification('보유한 프리즘 코인이 부족합니다.', true);
        }
        function v2_handleBuy3DCube() {
            const cubePrice = 10000000;
            if (v2_userCash >= cubePrice) {
                v2_userCash -= cubePrice; v2_isCubePurchased = true;
                v2_dom.cubeOverlay.style.display = 'none';
                v2_updateUI();
                v2_showNotification('3D 큐브가 활성화되었습니다! (초당 +100 KRW)', false);
                v2_saveGameState();
            } else v2_showNotification('3D 큐브를 구매할 현금이 부족합니다. (필요: 1천만 KRW)', true);
        }
        function v2_handleUpgradePrism() {
            const prismCost = 100;
            if (v2_userPrisms >= prismCost) {
                v2_userPrisms -= prismCost; v2_isPrismUpgraded = true;
                v2_upgradeToPrismMaterial();
                v2_updateUI();
                v2_showNotification('프리즘 업그레이드 완료! (초당 +200 KRW)', false);
                v2_saveGameState();
            } else v2_showNotification('프리즘 업그레이드에 필요한 PRISM이 부족합니다. (필요: 100 PRISM)', true);
        }

        // --- v2 Firebase 로직 ---
        function v2_saveGameState() {
            if (!db || !userId || !appId) return;
            const gameState = {
                userCash: v2_userCash,
                userCubes: v2_userCubes,
                userPrisms: v2_userPrisms,
                transactions: v2_transactions,
                isCubePurchased: v2_isCubePurchased,
                isPrismUpgraded: v2_isPrismUpgraded,
                usedCodes: v2_usedCodes,
                paperClicks: v2_paperClicks,
                achievedPaperNovice: v2_achievedPaperNovice,
                achievedPaperPro: v2_achievedPaperPro,
                achievedPaperMaster: v2_achievedPaperMaster
            };
            if (window.setDoc && window.doc) {
                const docRef = window.doc(db, "artifacts", appId, "users", userId, "simulator_state", "game_data_v2"); // v2 전용 경로
                window.setDoc(docRef, gameState).catch(e => console.error("Error saving v2 state: ", e));
            }
        }

        function v2_loadGameState(docSnap) {
            if (docSnap.exists()) {
                console.log("Loading v2 saved data...");
                const data = docSnap.data();
                v2_userCash = data.userCash;
                v2_userCubes = data.userCubes;
                v2_userPrisms = data.userPrisms || 0;
                v2_transactions = data.transactions || [];
                v2_isCubePurchased = data.isCubePurchased;
                v2_isPrismUpgraded = data.isPrismUpgraded || false;
                v2_usedCodes = data.usedCodes || [];
                v2_paperClicks = data.paperClicks || 0;
                v2_achievedPaperNovice = data.achievedPaperNovice || false;
                v2_achievedPaperPro = data.achievedPaperPro || false;
                v2_achievedPaperMaster = data.achievedPaperMaster || false;
                
                if (v2_isPrismUpgraded) v2_upgradeToPrismMaterial();
                v2_calculatePaperStats();
                v2_updateUI();
                v2_updateTransactionHistory();
            } else {
                console.log("No v2 data found. Saving initial v2 state.");
                v2_saveGameState(); 
            }
        }

        // =======================================================
        // 메인 로더 및 Firebase 초기화
        // =======================================================
        
        let countdownInterval;

        function startCountdown() {
            const banner = document.getElementById('update-countdown-banner');
            const timerDisplay = document.getElementById('countdown-timer');
            const hideButton = document.getElementById('hide-countdown-banner');
            banner.classList.remove('hidden');

            hideButton.addEventListener('click', () => {
                banner.style.display = 'none';
            });

            if (countdownInterval) clearInterval(countdownInterval);

            countdownInterval = setInterval(() => {
                const now = getCurrentTime(); // 테스트 시간을 고려하여 현재 시간 다시 가져오기
                const timeLeft = UPDATE_TIME.getTime() - now.getTime();

                if (timeLeft <= 0) {
                    clearInterval(countdownInterval);
                    timerDisplay.textContent = "UPDATING...";
                    // 1초 후 새로고침하여 v2로 강제 전환
                    setTimeout(() => location.reload(), 1000);
                    return;
                }

                const hours = Math.floor((timeLeft / (1000 * 60 * 60)));
                const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

                timerDisplay.textContent = 
                    `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }, 1000);
        }

        function initFirebase(isV2) {
            import("https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js").then(({ initializeApp }) =>
            import("https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js").then(({ getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged }) =>
            import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js").then(({ getFirestore, doc, getDoc, setDoc, setLogLevel }) => {
                
                // Firestore 함수 전역 할당 (v0, v2에서 공통 사용)
                window.doc = doc;
                window.setDoc = setDoc;

                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                try {
                    const app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    db = getFirestore(app);
                    setLogLevel('Debug');

                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            console.log("Firebase user signed in:", user.uid);
                            userId = user.uid;

                            if (isV2) {
                                // v2 데이터 로드
                                const docRef = doc(db, "artifacts", appId, "users", userId, "simulator_state", "game_data_v2");
                                const docSnap = await getDoc(docRef);
                                v2_loadGameState(docSnap);
                            } else {
                                // v0 데이터 로드
                                const docRef = doc(db, "artifacts", appId, "users", userId, "simulator_state", "game_data");
                                const docSnap = await getDoc(docRef);
                                v0_loadGameState(docSnap);
                            }
                        } else {
                            console.log("No user. Attempting sign in...");
                            if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
                            else await signInAnonymously(auth);
                        }
                    });

                } catch (e) {
                    console.error("Firebase initialization failed: ", e);
                    if(isV2) v2_showNotification("데이터베이스 연결에 실패했습니다.", true);
                    else v0_showNotification("데이터베이스 연결에 실패했습니다.", true);
                }
            })));
        }

        window.onload = () => {
            const now = getCurrentTime();

            if (now >= UPDATE_TIME) {
                // === v2 (신 버전) 실행 ===
                console.log("Loading V2 (Post-Update)");
                document.getElementById('v0-container').style.display = 'none';
                document.getElementById('v2-container').style.display = 'block';
                initV2Game();
                initFirebase(true); // v2용 Firebase 초기화
            } else {
                // === v0 (구 버전) 실행 ===
                console.log("Loading V0 (Pre-Update)");
                document.getElementById('v0-container').style.display = 'block';
                document.getElementById('v2-container').style.display = 'none';
                initV0Game();
                initFirebase(false); // v0용 Firebase 초기화

                // 카운트다운 배너 체크
                if (now >= COUNTDOWN_START_TIME) {
                    console.log("Starting countdown timer...");
                    startCountdown();
                }
            }
        };

    </script>
</body>
</html>
