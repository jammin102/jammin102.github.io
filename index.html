<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D 큐브 코인 시뮬레이터 v.0.2.2</title>
    <!-- Tailwind CSS 로드 --><script src="https://cdn.tailwindcss.com"></script>
    <!-- Three.js (3D 라이브러리) 로드 --><script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- Chart.js (그래프 라이브러리) 로드 --><script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* 'Inter' 폰트 및 기본 스타일 적용 */
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden; /* 전체 페이지 스크롤 방지 */
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        
        /* 3D 캔버스 스타일 (renderer.domElement) */
        canvas {
            display: block;
        }
        
        /* 스크롤바 커스텀 */
        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #93c5fd; /* bg-blue-300 */
            border-radius: 20px;
        }

        /* 비활성화된 버튼 스타일 */
        .btn-disabled {
            background-color: #4b5563 !important; /* gray-600 */
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        /* 탭 활성화 스타일 */
        .tab-active {
            border-bottom-color: #60a5fa !important;
            color: #60a5fa !important;
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <div class="flex flex-col lg:flex-row w-full h-screen">

        <!-- 왼쪽: 3D 뷰어 및 현재 가격 -->
        <div id="canvas-container" class="lg:w-1/2 w-full h-1/2 lg:h-full relative bg-black transition-all duration-300">
            <!-- 3D 캔버스가 여기에 마운트됨 (JS에서) -->
            
            <!-- 현재 가격 표시 -->
            <div class="absolute top-4 left-4 bg-black/50 backdrop-blur-sm p-4 rounded-lg shadow-xl z-20">
                <!-- CUBE 가격 -->
                <div>
                    <h2 class="text-sm font-semibold text-blue-300 uppercase">CUBE-KRW</h2>
                    <div id="current-price" class="text-3xl font-bold text-white">10,000 KRW</div>
                    <div id="price-change" class="text-lg font-medium text-gray-300">-</div>
                </div>
                <!-- PRISM 가격 -->
                <div class="mt-4">
                    <h2 class="text-sm font-semibold text-pink-300 uppercase">PRISM-KRW</h2>
                    <div id="current-prism-price" class="text-3xl font-bold text-white">50,000 KRW</div>
                    <div id="prism-price-change" class="text-lg font-medium text-gray-300">-</div>
                </div>
            </div>

            <!-- 하단 UI 래퍼 (패시브 수입 + 업그레이드 버튼) -->
            <div class="absolute bottom-4 left-4 flex flex-col md:flex-row gap-4 items-start md:items-end z-20">
                <!-- 패시브 수입 표시 -->
                <div id="passive-income-display" class="bg-black/50 backdrop-blur-sm p-3 rounded-lg shadow-xl hidden">
                    <h3 class="text-sm font-semibold text-green-300">패시브 수입</h3>
                    <div id="income-per-second" class="text-lg font-bold text-white">+0 KRW / sec</div>
                </div>
                
                <!-- 프리즘 업그레이드 (오버레이에서 밖으로 이동) -->
                <div id="upgrade-prism-section" class="bg-black/50 backdrop-blur-sm p-4 rounded-lg shadow-xl text-center hidden">
                    <h3 class="text-lg font-bold mb-2 text-pink-300">프리즘 업그레이드</h3>
                    <p class="text-gray-300 text-sm mb-3">큐브를 프리즘으로 업그레이드 (초당 200 KRW)<br>(필요: 100 PRISM)</p>
                    <button id="upgrade-prism-button" class="w-full bg-pink-600 hover:bg-pink-700 text-white font-bold py-2 px-4 rounded-lg transition-colors shadow-lg">
                        100 PRISM에 업그레이드
                    </button>
                </div>
            </div>

            <!-- 큐브 구매 오버레이 -->
            <div id="cube-purchase-overlay" class="absolute inset-0 bg-black/70 backdrop-blur-sm flex flex-col justify-center items-center text-center p-4 z-10">
                <div id="buy-cube-section">
                    <h3 class="text-2xl font-bold mb-2">3D 큐브 잠금 해제</h3>
                    <p class="text-gray-300 mb-4">큐브의 실시간 3D 회전을 활성화하고 초당 100 KRW를 생산하려면 10,000,000 KRW가 필요합니다.</p>
                    <button id="buy-cube-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition-colors shadow-lg">
                        10,000,000 KRW에 구매
                    </button>
                </div>
            </div>
            
        </div>

        <!-- 오른쪽: 대시보드 (자산, 매매, 뉴스, 거래 내역) -->
        <div id="dashboard" class="lg:w-1/2 w-full h-1/2 lg:h-full p-6 bg-gray-800 flex flex-col gap-4 overflow-y-auto custom-scrollbar transition-all duration-300">

            <h1 class="text-3xl font-bold text-center text-white mb-2">큐브 코인 시뮬레이터 v.0.2.2</h1>

            <!-- 1. 내 자산 현황 -->
            <div class="bg-gray-700 rounded-lg shadow-lg">
                <div class="flex justify-between items-center p-4 cursor-pointer" id="toggle-assets">
                    <h3 class="text-lg font-semibold text-white">내 자산 현황</h3>
                    <svg class="w-5 h-5 text-gray-400" id="toggle-assets-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </div>
                <div id="content-assets" class="px-4 pb-4">
                    <div class="grid grid-cols-3 gap-4">
                        <div class="bg-gray-600 p-4 rounded-lg">
                            <h3 class="text-sm font-semibold text-gray-300">보유 현금 (KRW)</h3>
                            <div id="user-cash" class="text-2xl font-bold text-blue-400">100,000</div>
                        </div>
                        <div class="bg-gray-600 p-4 rounded-lg">
                            <h3 class="text-sm font-semibold text-gray-300">보유 큐브 (CUBE)</h3>
                            <div id="user-cubes" class="text-2xl font-bold text-purple-400">0</div>
                        </div>
                        <div class="bg-gray-600 p-4 rounded-lg">
                            <h3 class="text-sm font-semibold text-gray-300">보유 프리즘 (PRISM)</h3>
                            <div id="user-prisms" class="text-2xl font-bold text-pink-400">0</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. 매수 / 매도 -->
            <div class="bg-gray-700 rounded-lg shadow-lg">
                <div class="flex justify-between items-center p-4 cursor-pointer" id="toggle-trade">
                    <h3 class="text-lg font-semibold text-white">매수 / 매도</h3>
                    <svg class="w-5 h-5 text-gray-400" id="toggle-trade-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </div>
                <div id="content-trade" class="px-4 pb-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- CUBE 거래 -->
                        <div class="bg-gray-600 p-4 rounded-lg">
                            <label class="text-lg font-semibold text-blue-300">CUBE 거래</label>
                            <input type="number" id="amount-input-cube" value="1" min="1" class="w-full bg-gray-800 text-white p-2 rounded mt-2 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="CUBE 수량">
                            <div class="grid grid-cols-2 gap-4 mt-4">
                                <button id="buy-button-cube" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold p-3 rounded-lg transition-colors shadow-lg">
                                    매수
                                </button>
                                <button id="sell-button-cube" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold p-3 rounded-lg transition-colors shadow-lg">
                                    매도
                                </button>
                            </div>
                        </div>
                        <!-- PRISM 거래 -->
                        <div class="bg-gray-600 p-4 rounded-lg">
                            <label class="text-lg font-semibold text-pink-300">PRISM 거래</label>
                            <input type="number" id="amount-input-prism" value="1" min="1" class="w-full bg-gray-800 text-white p-2 rounded mt-2 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-pink-500" placeholder="PRISM 수량">
                            <div class="grid grid-cols-2 gap-4 mt-4">
                                <button id="buy-button-prism" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold p-3 rounded-lg transition-colors shadow-lg">
                                    매수
                                </button>
                                <button id="sell-button-prism" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold p-3 rounded-lg transition-colors shadow-lg">
                                    매도
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. 실시간 가격 차트 (탭으로 변경) -->
            <div class="bg-gray-700 rounded-lg shadow-lg">
                <div class="flex justify-between items-center p-4 cursor-pointer" id="toggle-charts">
                    <h3 class="text-lg font-semibold text-white">실시간 차트</h3>
                    <svg class="w-5 h-5 text-gray-400" id="toggle-charts-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </div>
                <div id="content-charts" class="px-4 pb-4">
                    <!-- 탭 네비게이션 -->
                    <nav class="flex border-b border-gray-600 mb-4">
                        <button id="chart-tab-cube" class="py-2 px-4 border-b-2 border-transparent text-gray-400 hover:text-white tab-active">
                            CUBE
                        </button>
                        <button id="chart-tab-prism" class="py-2 px-4 border-b-2 border-transparent text-gray-400 hover:text-white">
                            PRISM
                        </button>
                    </nav>
                    <!-- 차트 캔버스 -->
                    <div id="chart-cube-container" class="h-40">
                        <canvas id="price-chart"></canvas>
                    </div>
                    <div id="chart-prism-container" class="h-40 hidden">
                        <canvas id="prism-price-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- 4. 거래 내역 -->
            <div class="bg-gray-700 rounded-lg shadow-lg">
                <div class="flex justify-between items-center p-4 cursor-pointer" id="toggle-history">
                    <h3 class="text-lg font-semibold text-white">거래 내역</h3>
                    <svg class="w-5 h-5 text-gray-400" id="toggle-history-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </div>
                <div id="content-history" class="px-4 pb-4">
                    <div id="transaction-history" class="h-32 overflow-y-auto custom-scrollbar pr-2 bg-gray-600 rounded-lg p-2">
                        <!-- 거래 내역이 여기에 추가됩니다 --><div class="text-gray-400 text-sm text-center p-4">거래 내역이 없습니다.</div>
                    </div>
                </div>
            </div>

            <!-- 5. 실시간 뉴스 -->
            <div class="bg-gray-700 rounded-lg shadow-lg">
                <div class="flex justify-between items-center p-4 cursor-pointer" id="toggle-news">
                    <h3 class="text-lg font-semibold text-white">실시간 큐브 뉴스 (예측)</h3>
                    <svg class="w-5 h-5 text-gray-400" id="toggle-news-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </div>
                <div id="content-news" class="px-4 pb-4">
                    <div id="news-feed" class="h-24 overflow-y-auto custom-scrollbar pr-2 bg-gray-600 rounded-lg p-2">
                        <div class="text-gray-400 text-sm">시뮬레이터가 시작되었습니다. 다음 이벤트를 기다립니다...</div>
                    </div>
                </div>
            </div>

            <!-- 6. 돈벌이 (Part-time Jobs) -->
            <div class="bg-gray-700 rounded-lg shadow-lg">
                <div class="flex justify-between items-center p-4 cursor-pointer" id="toggle-jobs">
                    <h3 class="text-lg font-semibold text-white">다양한 돈벌이</h3>
                    <svg class="w-5 h-5 text-gray-400" id="toggle-jobs-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </div>
                <div id="content-jobs" class="px-4 pb-4">
                    <div class="grid grid-cols-1 gap-4"> <!-- grid-cols-2 -> 1 -->
                        <button id="job-paper" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold p-3 rounded-lg transition-colors shadow-lg">
                            폐지 줍기 (+500)
                            <span id="job-paper-timer" class="text-xs block"></span>
                        </button>
                        <!-- '벽돌 운반' 버튼 제거됨 -->
                    </div>
                </div>
            </div>

            <!-- 7. 코드 입력 -->
            <div class="bg-gray-700 rounded-lg shadow-lg">
                <div class="flex justify-between items-center p-4 cursor-pointer" id="toggle-code">
                    <h3 class="text-lg font-semibold text-white">코드 입력</h3>
                    <svg class="w-5 h-5 text-gray-400" id="toggle-code-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </div>
                <div id="content-code" class="px-4 pb-4">
                    <div class="flex gap-4">
                        <input type="text" id="code-input" class="w-full bg-gray-800 text-white p-2 rounded border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="코드를 입력하세요 (코드당 1회)">
                        <button id="code-submit-button" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded-lg transition-colors shadow-lg">
                            입력
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 8. 업데이트 내역 (v.0.2.2) -->
            <div class="bg-gray-700 rounded-lg shadow-lg">
                <div class="flex justify-between items-center p-4 cursor-pointer" id="toggle-updates">
                    <h3 class="text-lg font-semibold text-white">업데이트 내역 (v.0.2.2)</h3>
                    <svg class="w-5 h-5 text-gray-400" id="toggle-updates-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </div>
                <div id="content-updates" class="px-4 pb-4 hidden">
                    <ul class="list-disc list-inside text-gray-300 text-sm space-y-1">
                        <li>콘솔 오류(SyntaxError) 수정 및 Firebase 로직 안정화</li>
                        <li>코드 입력 횟수 1회 제한 (계정당)</li>
                        <li>프리즘 업그레이드 UI 위치 변경 (패시브 수입창 옆)</li>
                        <li>'벽돌 운반' 기능 제거</li>
                        <li>'폐지 줍기' 발전과제 시스템 추가 (최대 5배 수입)</li>
                        <li>v.0.2.2 업데이트 내역 추가</li>
                    </ul>
                </div>
            </div>

        </div>
    </div>
    
    <!-- 알림 메시지 (에러 등) -->
    <div id="notification" class="fixed bottom-6 right-6 bg-red-500 text-white p-4 rounded-lg shadow-xl transition-all duration-300 opacity-0 translate-y-10 z-50">
        메시지 내용
    </div>

    <script>
        // --- Firebase 인스턴스 (module 스크립트에서 채워짐) ---
        let db, auth, userId, appId;

        // --- Three.js 3D 큐브 설정 ---
        let scene, camera, renderer, cube, cubeMaterial, light;

        function initThree() {
            const container = document.getElementById('canvas-container');
            if (!container) return;

            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
            camera.position.z = 5;

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            container.prepend(renderer.domElement); 

            // 큐브
            const geometry = new THREE.BoxGeometry(2.5, 2.5, 2.5);
            cubeMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x60a5fa, // Tailwind blue-400
                metalness: 0.5,
                roughness: 0.1
            });
            cube = new THREE.Mesh(geometry, cubeMaterial);
            
            const wireframeGeometry = new THREE.EdgesGeometry(cube.geometry);
            const wireframeMaterial = new THREE.LineBasicMaterial({ color: 0xffffff, linewidth: 2 });
            const wireframe = new THREE.LineSegments(wireframeGeometry, wireframeMaterial);
            cube.add(wireframe);

            scene.add(cube);

            // 빛
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
            scene.add(ambientLight);
            
            light = new THREE.DirectionalLight(0xffffff, 1);
            light.position.set(5, 5, 5);
            scene.add(light);

            window.addEventListener('resize', onWindowResize, false);
            animate();
        }
        
        // 큐브를 프리즘으로 업그레이드 (형태 유지, 재질만 변경)
        function upgradeToPrismMaterial() {
            if (!cubeMaterial) return;
            
            cubeMaterial.color.set(0xf472b6); // 핑크색
            cubeMaterial.metalness = 0.2;
            cubeMaterial.roughness = 0;
            cubeMaterial.transmission = 1.0; // 투명하게
            cubeMaterial.ior = 1.5; // 굴절률
            cubeMaterial.thickness = 1.0; 
            
            isPrismUpgraded = true;
            console.log("Upgraded to Prism Material!");
        }

        // 애니메이션
        let lastIncomeTime = Date.now();
        function animate() {
            requestAnimationFrame(animate);
            
            if (isCubePurchased && cube) { // 큐브를 구매했거나 업그레이드 했을 때만
                cube.rotation.x += 0.005;
                cube.rotation.y += 0.005;
            }
            
            // 패시브 수입
            const now = Date.now();
            if (now - lastIncomeTime > 1000 && (isCubePurchased || isPrismUpgraded)) {
                let income = 0;
                if (isPrismUpgraded) {
                    income = 200;
                } else if (isCubePurchased) {
                    income = 100;
                }

                if (income > 0) {
                    userCash += income;
                    if (cashDisplay) { // UI 즉시 업데이트
                        cashDisplay.textContent = userCash.toLocaleString('ko-KR');
                    }
                }
                lastIncomeTime = now;
            }

            if (renderer) {
                renderer.render(scene, camera);
            }
        }

        // 브라우저 창 크기 조절
        function onWindowResize() {
            const container = document.getElementById('canvas-container');
            if (container && renderer) {
                camera.aspect = container.clientWidth / container.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(container.clientWidth, container.clientHeight);
            }
        }
        
        // 큐브 색상 변경 (가격 변동 시)
        function flashObjectColor(color) {
            if (!isCubePurchased || !cubeMaterial) return;

            const originalColor = isPrismUpgraded ? 0xf472b6 : 0x60a5fa;
            cubeMaterial.color.set(color);

            setTimeout(() => {
                if (cubeMaterial) {
                    cubeMaterial.color.set(originalColor);
                }
            }, 500); 
        }


        // --- 차트 설정 ---
        let cubeChartInstance = null;
        let prismChartInstance = null;
        let cubePriceHistory = { labels: [], data: [] };
        let prismPriceHistory = { labels: [], data: [] };

        function initChart(canvasId, historyObject, color) {
            const ctx = document.getElementById(canvasId)?.getContext('2d');
            if (!ctx) return null;
            
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, `${color}80`); // 0.5 opacity
            gradient.addColorStop(1, `${color}00`); // 0 opacity

            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels: historyObject.labels,
                    datasets: [{
                        label: '가격',
                        data: historyObject.data,
                        borderColor: color,
                        backgroundColor: gradient,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { x: { display: false }, y: { ticks: { color: '#9ca3af' }, grid: { color: '#4b5563' } } },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function updateChart(instance, historyObject, newPrice) {
            const historyLimit = 20;
            const time = new Date().toLocaleTimeString('ko-KR').split(' ')[1] || new Date().toLocaleTimeString('ko-KR');
            
            historyObject.labels.push(time);
            historyObject.data.push(newPrice);
            
            if (historyObject.labels.length > historyLimit) {
                historyObject.labels.shift();
                historyObject.data.shift();
            }
            
            if (instance) {
                instance.data.labels = historyObject.labels;
                instance.data.datasets[0].data = historyObject.data;
                instance.update('none');
            }
        }


        // --- 시뮬레이터 로직 ---
        
        // 1. 상태 변수
        let userCash = 100000; // 10만원 시작
        let userCubes = 0;
        let userPrisms = 0;
        let currentPrice = 10000; // 1만원 시작
        let lastPrice = 10000; // 1만원 시작
        let currentPrismPrice = 50000;
        let lastPrismPrice = 50000;
        let transactions = [];
        let isCubePurchased = false; 
        let isPrismUpgraded = false;
        let usedCodes = []; // 코드 1회 사용
        
        // 돈벌이 상태
        let paperCooldown = false;
        // '폐지 줍기' 발전과제
        let paperClicks = 0;
        let achievedPaperNovice = false;
        let achievedPaperPro = false;
        let achievedPaperMaster = false;
        // '폐지 줍기' 파생 변수 (저장 X, 로드 시 계산)
        let paperIncome = 500;
        let paperCooldownTime = 2000; // 2초

        // 2. DOM 요소
        let cashDisplay, cubesDisplay, prismsDisplay, priceDisplay, priceChangeDisplay,
            prismPriceDisplay, prismPriceChangeDisplay, 
            amountInputCube, buyButtonCube, sellButtonCube,
            amountInputPrism, buyButtonPrism, sellButtonPrism,
            newsFeed, transactionHistory, notification, 
            buyCubeButton, cubeOverlay, buyCubeSection, upgradePrismSection, upgradePrismButton,
            jobPaper, jobPaperTimer,
            codeInput, codeSubmitButton,
            dashboard, canvasContainer,
            passiveIncomeDisplay, incomePerSecond,
            chartTabCube, chartTabPrism, chartCubeContainer, chartPrismContainer;

        // 3. UI 업데이트 함수
        function updateUI() {
            if (!cashDisplay) return; // DOM 로드 전이면 중단
            
            cashDisplay.textContent = userCash.toLocaleString('ko-KR');
            cubesDisplay.textContent = userCubes.toLocaleString('ko-KR');
            prismsDisplay.textContent = userPrisms.toLocaleString('ko-KR');
            
            // CUBE 가격
            priceDisplay.textContent = `${currentPrice.toLocaleString('ko-KR')} KRW`;
            const change = currentPrice - lastPrice;
            const changePercent = lastPrice > 0 ? ((change / lastPrice) * 100).toFixed(2) : 0;
            priceChangeDisplay.innerHTML = formatPriceChange(change, changePercent);
            
            // PRISM 가격
            prismPriceDisplay.textContent = `${currentPrismPrice.toLocaleString('ko-KR')} KRW`;
            const prismChange = currentPrismPrice - lastPrismPrice;
            const prismChangePercent = lastPrismPrice > 0 ? ((prismChange / lastPrismPrice) * 100).toFixed(2) : 0;
            prismPriceChangeDisplay.innerHTML = formatPriceChange(prismChange, prismChangePercent);
            
            // 큐브/프리즘 오버레이 및 업그레이드 버튼
            if (isPrismUpgraded) {
                cubeOverlay.style.display = 'none'; // 큐브 구매 오버레이 숨김
                upgradePrismSection.classList.add('hidden'); // 업그레이드 버튼 숨김
                passiveIncomeDisplay.classList.remove('hidden');
                incomePerSecond.textContent = '+200 KRW / sec';
            } else if (isCubePurchased) {
                cubeOverlay.style.display = 'none'; // 큐브 구매 오버레이 숨김
                upgradePrismSection.classList.remove('hidden'); // 업그레이드 버튼 표시
                passiveIncomeDisplay.classList.remove('hidden');
                incomePerSecond.textContent = '+100 KRW / sec';
            } else {
                cubeOverlay.style.display = 'flex'; // 큐브 구매 오버레이 표시
                upgradePrismSection.classList.add('hidden'); // 업그레이드 버튼 숨김
                passiveIncomeDisplay.classList.add('hidden');
            }
        }
        
        function formatPriceChange(change, percent) {
            if (change > 0) return `<span class="text-green-500">▲ ${change.toLocaleString('ko-KR')} (+${percent}%)</span>`;
            if (change < 0) return `<span class="text-red-500">▼ ${Math.abs(change).toLocaleString('ko-KR')} (${percent}%)</span>`;
            return `<span class="text-gray-400">0 (0.00%)</span>`;
        }

        // 거래 내역 업데이트
        function updateTransactionHistory() {
            if (!transactionHistory) return;
            if (transactions.length === 0) {
                transactionHistory.innerHTML = '<div class="text-gray-400 text-sm text-center p-4">거래 내역이 없습니다.</div>';
                return;
            }
            transactionHistory.innerHTML = ''; // 초기화
            transactions.slice(-100).forEach(tx => {
                const txElement = document.createElement('div');
                txElement.className = 'border-b border-gray-600 p-2 text-sm';
                
                const typeClass = tx.type === '매수' ? 'text-green-400' : 'text-red-400';
                const time = new Date(tx.timestamp).toLocaleTimeString('ko-KR');
                
                txElement.innerHTML = `
                    <div>
                        <span class="${typeClass} font-bold">[${tx.type}]</span> ${tx.amount.toLocaleString('ko-KR')} ${tx.coin}
                    </div>
                    <div class="text-xs text-gray-400">
                        체결가: ${tx.price.toLocaleString('ko-KR')} KRW | ${time}
                    </div>
                `;
                transactionHistory.prepend(txElement); // 최신 내역을 위로
            });
        }
        
        // 뉴스 생성
        function generateNews(news) {
            if (!newsFeed) return;
            const newsElement = document.createElement('div');
            
            let textColor = 'text-blue-200'; // 중립
            if (news.includes("급등") || news.includes("호재")) textColor = 'text-green-300';
            if (news.includes("급락") || news.includes("악재")) textColor = 'text-red-300';

            newsElement.className = `border-b border-gray-600 p-2 text-sm ${textColor}`;
            newsElement.textContent = `[${new Date().toLocaleTimeString('ko-KR')}] ${news}`;
            
            if (newsFeed.children.length === 1 && newsFeed.children[0].textContent.includes('기다립니다')) {
                newsFeed.innerHTML = '';
            }
            newsFeed.prepend(newsElement);
            if (newsFeed.children.length > 10) {
                newsFeed.removeChild(newsFeed.lastChild);
            }
        }
        
        // 알림 표시
        function showNotification(message, isError = true) {
            if (!notification) return;
            notification.textContent = message;
            notification.classList.remove(isError ? 'bg-green-500' : 'bg-red-500');
            notification.classList.add(isError ? 'bg-red-500' : 'bg-green-500');
            notification.classList.remove('opacity-0', 'translate-y-10');
            notification.classList.add('opacity-100', 'translate-y-0');
            setTimeout(() => {
                notification.classList.remove('opacity-100', 'translate-y-0');
                notification.classList.add('opacity-0', 'translate-y-10');
            }, 3000);
        }

        // 4. 핵심 로직: 가격 변동 (예측 시스템)
        
        // 가격 변동 계산
        function getPriceChange(coinType) {
            let direction, magnitudeRand, changePercent, ratios;
            
            if (coinType === 'CUBE') {
                direction = Math.random() < 0.52 ? 1 : -1; // 52/48
                ratios = { small: 0.50, medium: 0.95 }; // 50/45/5
            } else { // PRISM
                direction = Math.random() < 0.51 ? 1 : -1; // 51/49
                ratios = { small: 0.60, medium: 0.98 }; // 60/38/2
            }

            magnitudeRand = Math.random();
            let magnitude;

            if (magnitudeRand < ratios.small) { // 소
                changePercent = (Math.random() * 0.01) + 0.001; // 0.1% ~ 1.1%
                magnitude = 'small';
            } else if (magnitudeRand < ratios.medium) { // 중
                changePercent = (Math.random() * 0.04) + 0.011; // 1.1% ~ 5.1%
                magnitude = 'medium';
            } else { // 대
                changePercent = (Math.random() * 0.1) + 0.051; // 5.1% ~ 15.1%
                magnitude = 'large';
            }
            
            const price = (coinType === 'CUBE') ? currentPrice : currentPrismPrice;
            const priceChange = price * changePercent * direction;
            
            return { priceChange, magnitude, direction, coinType };
        }
        
        // 다음 이벤트 결정 (뉴스 + 가격 변동)
        function decideNextEvent() {
            const coinType = Math.random() < 0.5 ? 'CUBE' : 'PRISM';
            const { priceChange, magnitude, direction } = getPriceChange(coinType);
            
            let newsText = "";
            const coinName = coinType === 'CUBE' ? '큐브' : '프리즘';
            
            if (direction > 0) { // 상승
                if (magnitude === 'large') newsText = `[속보] ${coinName} 코인, 대형 호재 발표! 잠시 후 가격 급등이 예상됩니다!`;
                else if (magnitude === 'medium') newsText = `[정보] ${coinName} 코인, 기관 매수세 유입... 곧 완만한 상승이 시작될 듯.`;
                else newsText = `[분석] ${coinName} 코인, 단기 저점 확인... 소폭 반등 예상.`;
            } else { // 하락
                if (magnitude === 'large') newsText = `[속보] ${coinName} 코인, 대형 악재 발생! 잠시 후 가격 급락이 예상됩니다!`;
                else if (magnitude === 'medium') newsText = `[경고] ${coinName} 코인, 투자 심리 위축... 조정 장세 돌입 예상.`;
                else newsText = `[분석] ${coinName} 코인, 차익 실현 매물 출회... 소폭 하락 예상.`;
            }
            
            return { coinType, priceChange, newsText, direction };
        }
        
        // 가격 변동 적용
        function applyPriceChange(coinType, priceChange, direction) {
            if (coinType === 'CUBE') {
                lastPrice = currentPrice;
                currentPrice = Math.max(1000, currentPrice + priceChange);
                currentPrice = Math.round(currentPrice);
                updateChart(cubeChartInstance, cubePriceHistory, currentPrice);
                flashObjectColor(direction > 0 ? 0x86efac : 0xfca5a5); // 초록/빨강 (연하게)
            } else {
                lastPrismPrice = currentPrismPrice;
                currentPrismPrice = Math.max(500, currentPrismPrice + priceChange);
                currentPrismPrice = Math.round(currentPrismPrice);
                updateChart(prismChartInstance, prismPriceHistory, currentPrismPrice);
                // 프리즘은 큐브 색상에 영향
                flashObjectColor(direction > 0 ? 0x86efac : 0xfca5a5); // (연하게)
            }
            updateUI();
        }

        // 메인 게임 루프 (예측 뉴스 시스템)
        function gameLoop() {
            const { coinType, priceChange, newsText, direction } = decideNextEvent();
            
            // 1. 뉴스 선공개
            generateNews(newsText);
            
            // 2. 5초 후 가격 변동 적용
            setTimeout(() => {
                applyPriceChange(coinType, priceChange, direction);
            }, 5000); // 5초 딜레이
            
            // 3. 다음 루프 (10~15초 사이 랜덤)
            const nextLoopTime = Math.random() * 5000 + 10000;
            setTimeout(gameLoop, nextLoopTime);
        }

        // 5. 이벤트 리스너
        function getAmount(inputId) {
            const input = document.getElementById(inputId);
            if (!input) return 0;
            const amount = parseInt(input.value, 10);
            if (isNaN(amount) || amount <= 0) {
                showNotification('유효한 수량을 입력하세요.', true);
                return 0;
            }
            return amount;
        }
        
        // '폐지 줍기' 스탯 계산 (로드 시, 과제 달성 시 호출)
        function calculatePaperStats() {
            paperIncome = 500;
            paperCooldownTime = 2000;

            if (achievedPaperNovice) {
                paperCooldownTime -= 500; // 1.5초
                paperIncome = 500 * 2; // 1000
            }
            if (achievedPaperPro) {
                paperCooldownTime -= 500; // 1.0초
                paperIncome = 500 * 3; // 1500
            }
            if (achievedPaperMaster) {
                paperCooldownTime -= 200; // 0.8초
                paperIncome = 500 * 5; // 2500
            }
            
            // 버튼 텍스트 업데이트
            if (jobPaper) {
                jobPaper.innerHTML = `폐지 줍기 (+${paperIncome.toLocaleString('ko-KR')}) <span id="job-paper-timer" class="text-xs block"></span>`;
                // 타이머 DOM 다시 찾기
                jobPaperTimer = document.getElementById('job-paper-timer');
            }
        }
        
        // '폐지 줍기' 과제 체크
        function checkPaperAchievements() {
            let achievementUnlocked = false;
            
            if (!achievedPaperNovice && paperClicks >= 10) {
                achievedPaperNovice = true;
                showNotification("발전과제: 폐지 줍기 중수 달성! (쿨타임 -0.5초, 수입 2배)", false);
                achievementUnlocked = true;
            }
            if (!achievedPaperPro && paperClicks >= 30) {
                achievedPaperPro = true;
                showNotification("발전과제: 폐지 줍기 고수 달성! (쿨타임 -0.5초, 수입 총 3배)", false);
                achievementUnlocked = true;
            }
            if (!achievedPaperMaster && paperClicks >= 100) {
                achievedPaperMaster = true;
                showNotification("발전과제: 폐지 줍기 고인물 달성! (쿨타임 -0.2초, 수입 총 5배)", false);
                achievementUnlocked = true;
            }
            
            if (achievementUnlocked) {
                calculatePaperStats(); // 스탯 즉시 재계산 및 UI 반영
            }
        }

        // 돈벌이 버튼 핸들러
        function handleJobClick(jobType) {
            if (jobType === 'paper') {
                paperClicks++; // 클릭 횟수 증가
                checkPaperAchievements(); // 과제 달성 여부 체크
                
                if (paperCooldown) return showNotification('폐지 줍기 쿨타임 중입니다.', true);
                
                userCash += paperIncome; // 계산된 수입 적용
                paperCooldown = true;
                jobPaper.classList.add('btn-disabled');
                
                let timer = paperCooldownTime / 1000; // 계산된 쿨타임 적용
                jobPaperTimer.textContent = `(${timer.toFixed(1)}초)`;
                const interval = setInterval(() => {
                    timer -= 0.1;
                    if (timer > 0) {
                        jobPaperTimer.textContent = `(${timer.toFixed(1)}초)`;
                    } else {
                        clearInterval(interval);
                        paperCooldown = false;
                        jobPaper.classList.remove('btn-disabled');
                        jobPaperTimer.textContent = '';
                    }
                }, 100); // 0.1초마다 갱신 (0.8초 쿨타임을 위해)
            }
            
            updateUI(); // 현금 즉시 반영
            saveGameState(); // 클릭 횟수 등 저장
        }
        
        // 코드 입력 핸들러
        function handleCodeSubmit() {
            const code = codeInput.value.trim();
            if (code === '') return;

            if (usedCodes.includes(code)) {
                showNotification('이미 사용된 코드입니다.', true);
                return;
            }

            if (code === 'PRISMUPDATE') {
                userPrisms += 1;
                showNotification('PRISM 1개를 획득했습니다!', false);
                usedCodes.push(code); // 사용 처리
                codeInput.value = '';
            } else if (code === 'ice_cube102') {
                userCash += 100000000; // 1억
                showNotification('개발자 코드! 1억 KRW를 획득했습니다!', false);
                usedCodes.push(code); // 사용 처리
                codeInput.value = '';
            } else {
                showNotification('유효하지 않은 코드입니다.', true);
            }
            updateUI();
            saveGameState(); // 사용된 코드 목록 저장
        }
        
        // GUI 토글 (개별 토글)
        function setupSectionToggle(buttonId, contentId, iconId) {
            const button = document.getElementById(buttonId);
            const content = document.getElementById(contentId);
            const icon = document.getElementById(iconId);
            if (!button || !content || !icon) return;

            button.addEventListener('click', () => {
                content.classList.toggle('hidden');
                icon.classList.toggle('rotate-180');
            });
        }

        // --- Firebase 저장 함수 ---
        function saveGameState() {
            if (!db || !userId || !appId) return;
            
            const gameState = {
                userCash: userCash,
                userCubes: userCubes,
                userPrisms: userPrisms,
                transactions: transactions,
                isCubePurchased: isCubePurchased,
                isPrismUpgraded: isPrismUpgraded,
                usedCodes: usedCodes, // 사용된 코드 저장
                paperClicks: paperClicks, // 폐지 줍기 횟수 저장
                achievedPaperNovice: achievedPaperNovice,
                achievedPaperPro: achievedPaperPro,
                achievedPaperMaster: achievedPaperMaster
            };

            if (window.setDoc && window.doc) {
                const docRef = window.doc(db, "artifacts", appId, "users", userId, "simulator_state", "game_data_v2");
                window.setDoc(docRef, gameState).catch(e => console.error("Error saving game state: ", e));
            }
        }


        // 6. 초기화 및 시작
        window.onload = () => {
            // DOM 요소 할당
            cashDisplay = document.getElementById('user-cash');
            cubesDisplay = document.getElementById('user-cubes');
            prismsDisplay = document.getElementById('user-prisms');
            priceDisplay = document.getElementById('current-price');
            priceChangeDisplay = document.getElementById('price-change');
            prismPriceDisplay = document.getElementById('current-prism-price');
            prismPriceChangeDisplay = document.getElementById('prism-price-change');
            
            amountInputCube = document.getElementById('amount-input-cube');
            buyButtonCube = document.getElementById('buy-button-cube');
            sellButtonCube = document.getElementById('sell-button-cube');
            
            amountInputPrism = document.getElementById('amount-input-prism');
            buyButtonPrism = document.getElementById('buy-button-prism');
            sellButtonPrism = document.getElementById('sell-button-prism');
            
            newsFeed = document.getElementById('news-feed');
            transactionHistory = document.getElementById('transaction-history');
            notification = document.getElementById('notification');
            
            buyCubeButton = document.getElementById('buy-cube-button');
            cubeOverlay = document.getElementById('cube-purchase-overlay');
            buyCubeSection = document.getElementById('buy-cube-section');
            upgradePrismSection = document.getElementById('upgrade-prism-section');
            upgradePrismButton = document.getElementById('upgrade-prism-button');
            
            jobPaper = document.getElementById('job-paper');
            jobPaperTimer = document.getElementById('job-paper-timer');
            // '벽돌 운반' DOM 제거
            
            codeInput = document.getElementById('code-input');
            codeSubmitButton = document.getElementById('code-submit-button');
            
            dashboard = document.getElementById('dashboard');
            canvasContainer = document.getElementById('canvas-container');
            
            passiveIncomeDisplay = document.getElementById('passive-income-display');
            incomePerSecond = document.getElementById('income-per-second');

            // 차트 탭 요소 할당
            chartTabCube = document.getElementById('chart-tab-cube');
            chartTabPrism = document.getElementById('chart-tab-prism');
            chartCubeContainer = document.getElementById('chart-cube-container');
            chartPrismContainer = document.getElementById('chart-prism-container');

            // --- 이벤트 리스너 할당 ---
            
            // CUBE 거래
            buyButtonCube.addEventListener('click', () => {
                const amount = getAmount('amount-input-cube');
                if (amount === 0) return;
                const totalCost = currentPrice * amount;
                if (userCash >= totalCost) {
                    userCash -= totalCost;
                    userCubes += amount;
                    transactions.push({ type: '매수', coin: 'CUBE', amount: amount, price: currentPrice, timestamp: Date.now() });
                    updateUI();
                    updateTransactionHistory();
                    showNotification(`${amount.toLocaleString('ko-KR')} CUBE 매수 완료!`, false);
                    saveGameState();
                } else {
                    showNotification('보유 현금이 부족합니다.', true);
                }
            });
            sellButtonCube.addEventListener('click', () => {
                const amount = getAmount('amount-input-cube');
                if (amount === 0) return;
                if (userCubes >= amount) {
                    userCash += (currentPrice * amount);
                    userCubes -= amount;
                    transactions.push({ type: '매도', coin: 'CUBE', amount: amount, price: currentPrice, timestamp: Date.now() });
                    updateUI();
                    updateTransactionHistory();
                    showNotification(`${amount.toLocaleString('ko-KR')} CUBE 매도 완료!`, false);
                    saveGameState();
                } else {
                    showNotification('보유한 큐브 코인이 부족합니다.', true);
                }
            });

            // PRISM 거래
            buyButtonPrism.addEventListener('click', () => {
                const amount = getAmount('amount-input-prism');
                if (amount === 0) return;
                const totalCost = currentPrismPrice * amount;
                if (userCash >= totalCost) {
                    userCash -= totalCost;
                    userPrisms += amount;
                    transactions.push({ type: '매수', coin: 'PRISM', amount: amount, price: currentPrismPrice, timestamp: Date.now() });
                    updateUI();
                    updateTransactionHistory();
                    showNotification(`${amount.toLocaleString('ko-KR')} PRISM 매수 완료!`, false);
                    saveGameState();
                } else {
                    showNotification('보유 현금이 부족합니다.', true);
                }
            });
            sellButtonPrism.addEventListener('click', () => {
                const amount = getAmount('amount-input-prism');
                if (amount === 0) return;
                if (userPrisms >= amount) {
                    userCash += (currentPrismPrice * amount);
                    userPrisms -= amount;
                    transactions.push({ type: '매도', coin: 'PRISM', amount: amount, price: currentPrismPrice, timestamp: Date.now() });
                    updateUI();
                    updateTransactionHistory();
                    showNotification(`${amount.toLocaleString('ko-KR')} PRISM 매도 완료!`, false);
                    saveGameState();
                } else {
                    showNotification('보유한 프리즘 코인이 부족합니다.', true);
                }
            });

            // 큐브 구매 / 업그레이드
            buyCubeButton.addEventListener('click', () => {
                const cubePrice = 10000000;
                if (userCash >= cubePrice) {
                    userCash -= cubePrice;
                    isCubePurchased = true;
                    cubeOverlay.style.display = 'none'; // 오버레이 영구 숨김
                    updateUI();
                    showNotification('3D 큐브가 활성화되었습니다! (초당 +100 KRW)', false);
                    saveGameState();
                } else {
                    showNotification('3D 큐브를 구매할 현금이 부족합니다. (필요: 1천만 KRW)', true);
                }
            });
            upgradePrismButton.addEventListener('click', () => {
                const prismCost = 100;
                if (userPrisms >= prismCost) {
                    userPrisms -= prismCost;
                    isPrismUpgraded = true;
                    upgradeToPrismMaterial(); // 3D 재질 변경
                    updateUI(); // UI 변경 (버튼 숨김 등)
                    showNotification('프리즘 업그레이드 완료! (초당 +200 KRW)', false);
                    saveGameState();
                } else {
                    showNotification('프리즘 업그레이드에 필요한 PRISM이 부족합니다. (필요: 100 PRISM)', true);
                }
            });
            
            // 돈벌이
            jobPaper.addEventListener('click', () => handleJobClick('paper'));
            
            // 코드
            codeSubmitButton.addEventListener('click', handleCodeSubmit);
            
            // 차트 탭 리스너
            chartTabCube.addEventListener('click', () => {
                chartTabCube.classList.add('tab-active');
                chartTabPrism.classList.remove('tab-active');
                chartCubeContainer.classList.remove('hidden');
                chartPrismContainer.classList.add('hidden');
            });
            chartTabPrism.addEventListener('click', () => {
                chartTabPrism.classList.add('tab-active');
                chartTabCube.classList.remove('tab-active');
                chartPrismContainer.classList.remove('hidden');
                chartCubeContainer.classList.add('hidden');
            });

            // 개별 섹션 토글 리스너 설정
            setupSectionToggle('toggle-assets', 'content-assets', 'toggle-assets-icon');
            setupSectionToggle('toggle-trade', 'content-trade', 'toggle-trade-icon');
            setupSectionToggle('toggle-charts', 'content-charts', 'toggle-charts-icon');
            setupSectionToggle('toggle-history', 'content-history', 'toggle-history-icon');
            setupSectionToggle('toggle-news', 'content-news', 'toggle-news-icon');
            setupSectionToggle('toggle-jobs', 'content-jobs', 'toggle-jobs-icon');
            setupSectionToggle('toggle-code', 'content-code', 'toggle-code-icon');
            setupSectionToggle('toggle-updates', 'content-updates', 'toggle-updates-icon');

            // --- 초기화 ---
            initThree(); // 3D 씬
            cubeChartInstance = initChart('price-chart', cubePriceHistory, '#60a5fa');
            prismChartInstance = initChart('prism-price-chart', prismPriceHistory, '#f472b6');
            
            calculatePaperStats(); // '폐지 줍기' 초기 스탯 계산
            updateUI(); // UI (기본값)
            updateTransactionHistory(); // 거래 내역 (기본값)
            
            // 예측 뉴스 게임 루프 시작
            gameLoop();
        };
        
    </script>

    <!-- Firebase SDK 모듈 스크립트 -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firestore 함수를 전역 스코프로 노출 (메인 스크립트에서 사용)
        window.doc = doc;
        window.setDoc = setDoc;

        // Firebase 설정
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appIdGlobal = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        try {
            const app = initializeApp(firebaseConfig);
            const authGlobal = getAuth(app);
            const dbGlobal = getFirestore(app);
            setLogLevel('Debug'); // Firestore 로그 활성화

            // 전역 변수에 할당
            window.db = dbGlobal;
            window.auth = authGlobal;
            window.appId = appIdGlobal;

            onAuthStateChanged(authGlobal, async (user) => {
                if (user) {
                    console.log("Firebase user signed in:", user.uid);
                    window.userId = user.uid; // 전역 userId 설정

                    // v.0.2.0 데이터 로드 시도
                    const docRef = doc(dbGlobal, "artifacts", appIdGlobal, "users", user.uid, "simulator_state", "game_data_v2");
                    const docSnap = await getDoc(docRef);

                    if (docSnap.exists()) {
                        // 데이터가 있으면 로드
                        console.log("Loading v2 saved data...");
                        const data = docSnap.data();
                        window.userCash = data.userCash;
                        window.userCubes = data.userCubes;
                        window.userPrisms = data.userPrisms || 0;
                        window.transactions = data.transactions || [];
                        window.isCubePurchased = data.isCubePurchased;
                        window.isPrismUpgraded = data.isPrismUpgraded || false;
                        window.usedCodes = data.usedCodes || []; // 사용된 코드 로드
                        
                        // '폐지 줍기' 과제 로드
                        window.paperClicks = data.paperClicks || 0;
                        window.achievedPaperNovice = data.achievedPaperNovice || false;
                        window.achievedPaperPro = data.achievedPaperPro || false;
                        window.achievedPaperMaster = data.achievedPaperMaster || false;
                        
                        // 프리즘 업그레이드 3D 모델 적용
                        if (window.isPrismUpgraded) {
                            window.upgradeToPrismMaterial(); // 재질만 변경
                        }
                        
                        // '폐지 줍기' 스탯 계산
                        window.calculatePaperStats();
                        
                        // UI 즉시 업데이트
                        window.updateUI();
                        window.updateTransactionHistory();

                    } else {
                        // 데이터가 없으면 (최초 방문) 현재 기본값으로 저장
                        console.log("No v2 data found. Saving initial state.");
                        window.saveGameState(); 
                    }

                } else {
                    // 로그인되지 않았으면 로그인 시도 (*** 오류 수정 ***)
                    console.log("No user. Attempting sign in...");
                    if (initialAuthToken) {
                        await signInWithCustomToken(authGlobal, initialAuthToken);
                    } else {
                        await signInAnonymously(authGlobal);
                    }
                }
            });

        } catch (e) {
            console.error("Firebase initialization failed: ", e);
            if (window.showNotification) {
                window.showNotification("데이터베이스 연결에 실패했습니다.", true);
            }
        }

    </script>
</body>
</html>
